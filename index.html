<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Coin - Pro Firebase App</title>
    <style>
        :root {
            --primary: #ff6600; /* Orange */
            --primary-dark: #cc5200;
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-light: #e0e0e0;
            --text-muted: #a0a0a0;
            --success: #00c853;
            --danger: #ff3d00;
            --blue: #2979ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-light); padding-bottom: 70px; }
        
        .hidden { display: none !important; }
        .text-orange { color: var(--primary); }
        .text-blue { color: var(--blue); }
        .text-green { color: var(--success); }
        .btn {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        .input-group input, .input-group select {
            width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #333;
            color: white; border-radius: 6px; outline: none;
        }
        .input-group input:focus { border-color: var(--primary); }

        /* --- Toast Notification --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: var(--bg-card); border-left: 4px solid var(--primary); color: white;
            padding: 15px 20px; margin-bottom: 10px; border-radius: 4px; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- Auth Screen --- */
        #auth-screen {
            display: flex; justify-content: center; align-items: center; height: 100vh;
            background: linear-gradient(135deg, #121212, #2a1b0d);
        }
        .auth-box {
            background: var(--bg-card); padding: 30px; border-radius: 12px; width: 90%; max-width: 400px;
            border-top: 3px solid var(--primary);
        }
        .auth-toggle { text-align: center; margin-top: 15px; font-size: 0.9rem; cursor: pointer; color: var(--primary); }

        /* --- Layout --- */
        header {
            background: var(--bg-card); padding: 15px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100;
        }
        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; }
        
        /* Avatar Styles */
        .avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary);
            transition: transform 0.2s;
        }
        .avatar:hover { transform: scale(1.1); }
        
        .avatar-lg {
            width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary);
            display: block; margin: 0 auto 15px auto; cursor: pointer; box-shadow: 0 0 15px rgba(255,102,0,0.5);
        }

        /* Nav */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--bg-card);
            display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; z-index: 100;
        }
        .nav-item { color: var(--text-muted); text-decoration: none; font-size: 0.8rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }

        .section { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* Ticker & Chart */
        .ticker-wrap { width: 100%; background: #000; overflow: hidden; padding: 8px 0; white-space: nowrap; border-bottom: 1px solid var(--primary); }
        .ticker { display: inline-block; animation: ticker 20s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        .chart-container {
            background: var(--bg-card); padding: 15px; border-radius: 10px; margin-top: 15px;
            height: 200px; border: 1px solid #333; position: relative;
        }
        canvas { width: 100%; height: 100%; }

        /* Wallet Cards */
        .balance-card {
            background: linear-gradient(135deg, var(--primary), #ff9100); color: #fff;
            padding: 20px; border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(255, 102, 0, 0.3);
        }
        .balance-amount { font-size: 2rem; font-weight: bold; margin: 5px 0; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .menu-card {
            background: var(--bg-card); padding: 20px; border-radius: 12px; text-align: center;
            cursor: pointer; transition: 0.2s; border: 1px solid #333;
        }
        .menu-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .menu-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }

        /* Chat */
        .chat-box { background: var(--bg-card); height: 60vh; border-radius: 10px; display: flex; flex-direction: column; border: 1px solid #333; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 8px 12px; border-radius: 10px; font-size: 0.9rem; }
        .msg-admin { align-self: flex-start; background: #333; color: white; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; }
        .chat-input-area { padding: 10px; display: flex; gap: 10px; border-top: 1px solid #333; }

        /* Admin Table */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .admin-table th, .admin-table td { text-align: left; padding: 8px; border-bottom: 1px solid #333; }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .status-pending { background: #ff9800; color: black; }
        .status-approved { background: #00c853; color: white; }

        /* Premium Badge */
        .blue-tick { color: #1da1f2; margin-left: 2px; }
        .pro-badge { background: var(--primary); font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; margin-left: 5px; vertical-align: top;}

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-box">
            <h2 class="text-orange" style="text-align: center; margin-bottom: 20px;">TK Coin Login</h2>
            <form id="auth-form">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="auth-email" required placeholder="admin@app.com or user">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="auth-pass" required placeholder="******">
                </div>
                <button type="submit" class="btn" id="auth-btn">Login</button>
            </form>
            <div class="auth-toggle" onclick="window.toggleAuthMode()">Don't have an account? Signup</div>
            <div style="margin-top: 15px; font-size: 0.8rem; color: #666; text-align: center;">
                <strong>Admin:</strong> admin@app.com<br>
                <strong>Password:</strong> admin123
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <!-- News Ticker -->
        <div class="ticker-wrap"><div class="ticker" id="news-ticker">Loading News...</div></div>
        
        <header>
            <div class="logo">
                <i class="fas fa-coins"></i> TK Coin
                <span id="header-premium-badge" class="hidden blue-tick"><i class="fas fa-check-circle"></i></span>
            </div>
            <div class="user-info" onclick="window.showSection('profile')">
                <div style="text-align: right;">
                    <div id="header-name">Loading...</div>
                    <div id="header-balance" style="color: var(--primary);">0 TK</div>
                </div>
                <img src="" class="avatar" id="header-avatar" alt="User">
            </div>
        </header>

        <!-- User Views -->
        <main id="user-views">
            
            <!-- Market -->
            <section id="view-market" class="section">
                <div class="balance-card">
                    <div class="balance-title">Current TK Price</div>
                    <div class="balance-amount">$<span id="market-price">0.00</span></div>
                    <small style="opacity: 0.8;">+2.4% (24h)</small>
                </div>
                
                <div class="chart-container">
                    <canvas id="marketCanvas"></canvas>
                </div>

                <div style="margin-top: 20px;">
                    <h3>Live Rates</h3>
                    <div style="display: flex; justify-content: space-between; background: var(--bg-card); padding: 15px; margin-top: 10px; border-radius: 8px;">
                        <div>
                            <div style="font-size: 0.8rem; color: #aaa;">1 USDT</div>
                            <div style="font-weight: bold;" id="rate-usdt">Loading...</div>
                        </div>
                        <div>
                            <div style="font-size: 0.8rem; color: #aaa;">1 TK</div>
                            <div style="font-weight: bold;" id="rate-pkr">Loading...</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>News Feed</h3>
                    <div id="news-feed" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;"></div>
                </div>
            </section>

            <!-- Wallet -->
            <section id="view-wallet" class="section hidden">
                <div class="balance-card">
                    <div class="balance-title">Total Balance</div>
                    <div class="balance-amount"><span id="wallet-tk">0</span> TK</div>
                    <div style="font-size: 1rem; opacity: 0.9;"><span id="wallet-pkr">0</span> PKR</div>
                </div>

                <div class="menu-grid">
                    <div class="menu-card" onclick="window.showSection('deposit')">
                        <span class="menu-icon text-orange"><i class="fas fa-wallet"></i></span>
                        <div>Deposit</div>
                    </div>
                    <div class="menu-card" onclick="window.showSection('withdraw')">
                        <span class="menu-icon text-green"><i class="fas fa-money-bill-wave"></i></span>
                        <div>Withdraw</div>
                    </div>
                    <div class="menu-card" onclick="window.showSection('transfer')">
                        <span class="menu-icon text-blue"><i class="fas fa-exchange-alt"></i></span>
                        <div>Transfer</div>
                    </div>
                    <div class="menu-card" onclick="window.showSection('premium')">
                        <span class="menu-icon" style="color: gold;"><i class="fas fa-crown"></i></span>
                        <div>Pro</div>
                    </div>
                </div>

                <h3>Transaction History</h3>
                <div id="transaction-list" style="margin-top: 10px;"></div>
            </section>

            <!-- Deposit -->
            <section id="view-deposit" class="section hidden">
                <h2 class="text-orange">Deposit Funds</h2>
                <div class="input-group">
                    <label>Method</label>
                    <select id="deposit-method" onchange="window.updateDepositDetails()">
                        <option value="easypaisa">Easypaisa</option>
                        <option value="jazzcash">JazzCash</option>
                        <option value="usdt">USDT (TRC20)</option>
                    </select>
                </div>
                
                <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.8rem; color: #aaa;">Deposit To:</div>
                            <div style="font-weight: bold; font-size: 1.1rem;" id="deposit-number">0300-1234567</div>
                            <div style="font-size: 0.8rem; color: var(--primary);" id="deposit-name">Ali Khan - Easypaisa</div>
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="window.copyDepositNumber()"><i class="fas fa-copy"></i></button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Amount Sent (PKR)</label>
                    <input type="number" id="deposit-amount" oninput="window.calculateDeposit()" placeholder="1000">
                </div>
                <div class="input-group">
                    <label>Reference No / Transaction ID</label>
                    <input type="text" id="deposit-ref" placeholder="TRX ID">
                </div>

                <div style="background: #222; padding: 10px; border-radius: 6px; margin-bottom: 20px;">
                    <small>You will receive: <strong><span id="deposit-calc-receive">0</span> TK</strong></small>
                </div>

                <button class="btn" onclick="window.submitDeposit()">Submit Deposit Request</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="window.showSection('wallet')">Back</button>
            </section>

            <!-- Withdraw -->
            <section id="view-withdraw" class="section hidden">
                <h2 class="text-orange">Withdraw Funds</h2>
                <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div>Available Balance: <strong id="withdraw-bal-display">0 TK</strong></div>
                    <div style="font-size: 0.8rem; color: var(--primary);" id="fee-display">Fee: 5%</div>
                </div>

                <div class="input-group">
                    <label>Method</label>
                    <select id="withdraw-method">
                        <option value="easypaisa">Easypaisa</option>
                        <option value="jazzcash">JazzCash</option>
                        <option value="usdt">USDT</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Account Number / Address</label>
                    <input type="text" id="withdraw-account" placeholder="0300...">
                </div>

                <div class="input-group">
                    <label>Amount (TK)</label>
                    <input type="number" id="withdraw-amount" placeholder="Min 50 TK">
                </div>

                <button class="btn" onclick="window.submitWithdraw()">Request Withdrawal</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="window.showSection('wallet')">Back</button>
            </section>

            <!-- Transfer -->
            <section id="view-transfer" class="section hidden">
                <h2 class="text-orange">Transfer Coins</h2>
                <div class="input-group">
                    <label>Receiver Email</label>
                    <input type="email" id="transfer-email" placeholder="user@example.com">
                </div>
                <div class="input-group">
                    <label>Amount (TK)</label>
                    <input type="number" id="transfer-amount" placeholder="Amount">
                </div>

                <button class="btn" onclick="window.submitTransfer()">Send Now</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="window.showSection('wallet')">Back</button>
            </section>

            <!-- Premium -->
            <section id="view-premium" class="section hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-crown" style="font-size: 4rem; color: gold; margin-bottom: 15px;"></i>
                    <h2>Go Premium</h2>
                    <p>Unlock Zero Fee, Blue Tick & VIP Features.</p>
                </div>

                <div class="balance-card" style="text-align: center;">
                    <div class="balance-title">Upgrade Cost</div>
                    <div class="balance-amount">100 TK</div>
                    <div style="margin-top: 10px;">
                        <i class="fas fa-check-circle"></i> 0% Withdraw Fee<br>
                        <i class="fas fa-check-circle"></i> Premium Badge<br>
                        <i class="fas fa-check-circle"></i> Special Access
                    </div>
                </div>

                <button class="btn" id="btn-upgrade" onclick="window.upgradePremium()">Upgrade Now</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="window.showSection('wallet')">Back</button>
            </section>

            <!-- Chat -->
            <section id="view-chat" class="section hidden">
                <h2>Live Support</h2>
                <div class="chat-box">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Msgs -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Type a message..." style="flex: 1; padding: 8px; border-radius: 4px; border: none; background: #333; color: white;">
                        <button class="btn btn-sm" onclick="window.sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </section>

            <!-- Profile -->
            <section id="view-profile" class="section hidden">
                <div style="text-align: center;">
                    <!-- Avatar: Click to Change -->
                    <img src="" class="avatar-lg" id="profile-avatar" title="Click to change avatar" onclick="window.changeAvatar()">
                    <small style="color: var(--primary); cursor: pointer;" onclick="window.changeAvatar()"><i class="fas fa-sync"></i> Change Avatar</small>
                    
                    <h2 id="profile-name">User Name</h2>
                    <p id="profile-email" style="color: #aaa;">user@email.com</p>
                    <div id="profile-status" style="margin-top: 5px; font-size: 0.9rem; color: var(--primary);">Standard User</div>
                </div>

                <h3>Settings</h3>
                <div class="menu-card" onclick="window.showAboutModal()" style="text-align: left; margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> About App
                </div>
                <button class="btn" style="background: #333;" onclick="window.logout()">Logout</button>
            </section>
        </main>

        <!-- Admin Views -->
        <main id="admin-views" class="hidden">
            <section id="view-admin-dashboard" class="section">
                <h2 class="text-orange">Admin Dashboard</h2>
                
                <div class="menu-grid" style="margin-top: 20px;">
                    <div class="menu-card" onclick="window.showAdminSection('market')">
                        <span class="menu-icon text-orange"><i class="fas fa-chart-line"></i></span>
                        <div>Market</div>
                    </div>
                    <div class="menu-card" onclick="window.showAdminSection('deposits')">
                        <span class="menu-icon text-green"><i class="fas fa-check-double"></i></span>
                        <div>Deposits <span id="admin-dep-pending-count" class="badge" style="background:red; padding:2px 5px; border-radius:50%; font-size:0.7rem; color:white;">0</span></div>
                    </div>
                    <div class="menu-card" onclick="window.showAdminSection('users')">
                        <span class="menu-icon text-blue"><i class="fas fa-users"></i></span>
                        <div>Users</div>
                    </div>
                    <div class="menu-card" onclick="window.showAdminSection('news')">
                        <span class="menu-icon"><i class="fas fa-newspaper"></i></span>
                        <div>News</div>
                    </div>
                </div>

                <div class="menu-card" onclick="window.showAdminSection('chat')" style="text-align: left; margin-bottom: 20px;">
                    <span class="menu-icon"><i class="fas fa-comments"></i></span>
                    <div>Live Support Chats</div>
                </div>
            </section>

            <!-- Admin: Market Control -->
            <section id="admin-market" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Market Control</h3>
                <div class="input-group">
                    <label>TK Price (USD)</label>
                    <input type="number" id="admin-tk-price" onchange="window.adminUpdateMarket()">
                </div>
                <div class="input-group">
                    <label>USDT to PKR Rate</label>
                    <input type="number" id="admin-usdt-rate" onchange="window.adminUpdateMarket()">
                </div>
            </section>

            <!-- Admin: Deposits -->
            <section id="admin-deposits" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Deposit & Withdraw Requests</h3>
                <div id="admin-deposit-list" style="margin-top:10px;"></div>
            </section>

            <!-- Admin: Users -->
            <section id="admin-users" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">User Management</h3>
                <div id="admin-user-list" style="margin-top:10px;"></div>
            </section>

            <!-- Admin: News -->
            <section id="admin-news" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Post News</h3>
                <div class="input-group">
                    <label>Headline</label>
                    <input type="text" id="admin-news-headline">
                </div>
                <button class="btn" onclick="window.postNews()">Post Update</button>
            </section>

             <!-- Admin: Chat -->
             <section id="admin-chat" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="window.showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">User Chats</h3>
                <div id="admin-chat-list">
                    <!-- List of users to chat with -->
                </div>
                <div id="admin-chat-window" class="chat-box hidden">
                     <div class="chat-messages" id="admin-chat-messages"></div>
                     <div class="chat-input-area">
                         <input type="text" id="admin-chat-input" placeholder="Reply...">
                         <button class="btn btn-sm" onclick="window.adminSendReply()">Reply</button>
                     </div>
                </div>
            </section>

        </main>

        <!-- Bottom Navigation (User Only) -->
        <nav class="bottom-nav" id="user-nav">
            <a class="nav-item active" onclick="window.showSection('market')">
                <i class="fas fa-chart-line"></i>
                <span>Market</span>
            </a>
            <a class="nav-item" onclick="window.showSection('wallet')">
                <i class="fas fa-wallet"></i>
                <span>Wallet</span>
            </a>
            <a class="nav-item" onclick="window.showSection('chat')">
                <i class="fas fa-comment-dots"></i>
                <span>Chat</span>
            </a>
            <a class="nav-item" onclick="window.showSection('profile')">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </nav>
    </div>

    <!-- FIREBASE SCRIPTS -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
      import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, addDoc, onSnapshot, query, where, orderBy, getDocs, serverTimestamp, arrayUnion, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCChxbenpYlcBxTiqPqBDrjOefHkotX7Zg",
        authDomain: "tkcoinfinel.firebaseapp.com",
        databaseURL: "https://tkcoinfinel-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tkcoinfinel",
        storageBucket: "tkcoinfinel.firebasestorage.app",
        messagingSenderId: "131190927556",
        appId: "1:131190927556:web:4920420b66522722c7d991",
        measurementId: "G-2M0LDFRFH5"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- GLOBAL VARIABLES ---
      let currentUserData = null;
      let unsubscribeUser = null;
      let unsubscribeMarket = null;
      let unsubscribeChat = null;
      let currentAdminChatUser = null;
      
      // Avatar Seeds List
      const avatarSeeds = ['alex', 'bob', 'charlie', 'david', 'emma', 'frank', 'grace', 'henry', 'ivy', 'jack'];

      // --- AUTH LOGIC ---
      let isSignup = false;

      window.toggleAuthMode = function() {
          isSignup = !isSignup;
          document.querySelector('.auth-box h2').innerText = isSignup ? "Create Account" : "TK Coin Login";
          document.getElementById('auth-btn').innerText = isSignup ? "Signup" : "Login";
          document.querySelector('.auth-toggle').innerText = isSignup ? "Already have an account? Login" : "Don't have an account? Signup";
      };

      document.getElementById('auth-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const email = document.getElementById('auth-email').value.trim();
          const pass = document.getElementById('auth-pass').value.trim();
          const btn = document.getElementById('auth-btn');

          if (!email || !pass) return showToast("Please fill all fields", "error");
          
          btn.disabled = true;
          btn.innerText = "Processing...";

          try {
              if (isSignup) {
                  // 1. Create Auth User
                  const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                  const user = userCredential.user;
                  
                  // 2. Determine Role
                  let role = 'user';
                  if (email.toLowerCase() === 'admin@app.com') role = 'admin';

                  // 3. Create Firestore Doc
                  const randomSeed = avatarSeeds[Math.floor(Math.random() * avatarSeeds.length)];
                  const randomAvatar = `https://picsum.photos/seed/${randomSeed}/200/200`;

                  await setDoc(doc(db, "users", user.uid), {
                      email: email,
                      name: email.split('@')[0],
                      role: role,
                      isPremium: false,
                      balanceTK: 0,
                      avatar: randomAvatar,
                      createdAt: serverTimestamp()
                  });

                  // 4. Initialize Market if not exists (One time setup)
                  const marketRef = doc(db, "market", "global");
                  const marketSnap = await getDoc(marketRef);
                  if (!marketSnap.exists()) {
                      await setDoc(marketRef, {
                          tkPrice: 1.50,
                          usdtRate: 280,
                          news: [{ title: "Welcome to TK Coin! Official Launch." }]
                      });
                  }

                  showToast("Account created successfully!");
              } else {
                  // Login
                  await signInWithEmailAndPassword(auth, email, pass);
                  showToast("Logged in successfully!");
              }
          } catch (error) {
              console.error(error);
              showToast(error.message, "error");
          } finally {
              btn.disabled = false;
              btn.innerText = isSignup ? "Signup" : "Login";
          }
      });

      window.logout = function() {
          signOut(auth).then(() => {
              showToast("Logged out");
          });
      };

      // --- STATE MANAGEMENT ---
      onAuthStateChanged(auth, (user) => {
          if (user) {
              document.getElementById('auth-screen').classList.add('hidden');
              document.getElementById('app-container').classList.remove('hidden');
              loadUserData(user.uid);
              loadMarketData();
          } else {
              document.getElementById('auth-screen').classList.remove('hidden');
              document.getElementById('app-container').classList.add('hidden');
              if(unsubscribeUser) unsubscribeUser();
              if(unsubscribeMarket) unsubscribeMarket();
          }
      });

      // --- DATA LOADERS ---
      function loadUserData(uid) {
          unsubscribeUser = onSnapshot(doc(db, "users", uid), (docSnap) => {
              if (docSnap.exists()) {
                  currentUserData = docSnap.data();
                  currentUserData.id = uid; 
                  updateUI();
                  
                  if (currentUserData.role === 'admin') {
                      setupAdminView();
                  } else {
                      setupUserView(uid);
                  }
              }
          });
      }

      function setupUserView(uid) {
          document.getElementById('user-nav').classList.remove('hidden');
          document.getElementById('user-views').classList.remove('hidden');
          document.getElementById('admin-views').classList.add('hidden');
          
          // Load Transactions (Realtime)
          const q = query(collection(db, "transactions"), where("userId", "==", uid), orderBy("timestamp", "desc"));
          onSnapshot(q, (snapshot) => {
              const list = document.getElementById('transaction-list');
              list.innerHTML = "";
              if(snapshot.empty) list.innerHTML = "<div style='text-align:center; color:#555; padding:20px;'>No transactions yet.</div>";
              
              snapshot.forEach((doc) => {
                  const t = doc.data();
                  const isDep = t.type === 'deposit';
                  const color = t.status === 'approved' ? 'text-green' : (t.status === 'rejected' ? 'text-danger' : 'text-orange');
                  list.innerHTML += `
                  <div style="background:var(--bg-card); padding:10px; border-radius:6px; border:1px solid #333; display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                      <div style="display:flex; align-items:center; gap:10px;">
                          <div style="background:#333; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas ${isDep ? 'fa-arrow-down text-green' : 'fa-arrow-up text-danger'}"></i></div>
                          <div>
                              <div style="font-weight:bold; text-transform:capitalize;">${t.type}</div>
                              <div style="font-size:0.8rem; color:#aaa;">${t.method || 'N/A'}</div>
                          </div>
                      </div>
                      <div style="text-align:right;">
                          <div class="${color}">${isDep ? '+' : '-'}${t.amount} TK</div>
                          <div class="status-badge status-${t.status}">${t.status.toUpperCase()}</div>
                      </div>
                  </div>`;
              });
          });

          // Load Chat
          loadUserChat(uid);
      }

      function setupAdminView() {
          document.getElementById('user-nav').classList.add('hidden');
          document.getElementById('user-views').classList.add('hidden');
          document.getElementById('admin-views').classList.remove('hidden');
          window.showAdminSection('dashboard');
      }

      function loadMarketData() {
          unsubscribeMarket = onSnapshot(doc(db, "market", "global"), (docSnap) => {
              if (docSnap.exists()) {
                  const data = docSnap.data();
                  document.getElementById('market-price').innerText = data.tkPrice.toFixed(2);
                  document.getElementById('rate-usdt').innerText = data.usdtRate + " PKR";
                  document.getElementById('rate-pkr').innerText = (data.tkPrice * data.usdtRate).toFixed(2) + " PKR";
                  
                  // Update Admin Inputs
                  document.getElementById('admin-tk-price').value = data.tkPrice;
                  document.getElementById('admin-usdt-rate').value = data.usdtRate;

                  // Ticker
                  let tickerHtml = "";
                  data.news.forEach(n => tickerHtml += `<span class="ticker-item">ðŸ“¢ ${n.title}</span>`);
                  document.getElementById('news-ticker').innerHTML = tickerHtml;

                  // News Feed
                  let feedHtml = "";
                  data.news.slice().reverse().forEach(n => {
                      feedHtml += `<div style="background:var(--bg-card); padding:10px; border-radius:6px;">${n.title}</div>`;
                  });
                  document.getElementById('news-feed').innerHTML = feedHtml;
                  
                  drawChart();
              }
          });
      }

      // --- UI FUNCTIONS ---
      function updateUI() {
          const u = currentUserData;
          if(!u) return;
          
          document.getElementById('header-name').innerText = u.name;
          document.getElementById('header-balance').innerText = u.balanceTK.toFixed(2) + " TK";
          document.getElementById('header-avatar').src = u.avatar;
          
          // Profile Section
          document.getElementById('profile-name').innerText = u.name;
          document.getElementById('profile-email').innerText = u.email;
          document.getElementById('profile-avatar').src = u.avatar;
          
          // Wallet Section
          document.getElementById('wallet-tk').innerText = u.balanceTK.toFixed(2);
          // Approx PKR based on market rate
          const usdtRate = parseFloat(document.getElementById('rate-usdt').innerText) || 280;
          document.getElementById('wallet-pkr').innerText = (u.balanceTK * usdtRate).toFixed(2);
          document.getElementById('withdraw-bal-display').innerText = u.balanceTK.toFixed(2) + " TK";

          // Premium Status
          if(u.isPremium) {
              document.getElementById('profile-status').innerHTML = `<span class="text-blue"><i class="fas fa-check-circle blue-tick"></i> Premium User</span>`;
              document.getElementById('header-premium-badge').classList.remove('hidden');
              document.getElementById('fee-display').innerText = "Fee: 0% (Pro)";
          } else {
              document.getElementById('profile-status').innerText = "Standard User";
              document.getElementById('header-premium-badge').classList.add('hidden');
              document.getElementById('fee-display').innerText = "Fee: 5%";
          }
      }

      // --- AVATAR CHANGE ---
      window.changeAvatar = async function() {
          if (!confirm("Change your avatar?")) return;
          // Simple logic: Generate a random new seed
          const randomSeed = Math.random().toString(36).substring(7);
          const newAvatar = `https://picsum.photos/seed/${randomSeed}/200/200`;
          
          try {
              await updateDoc(doc(db, "users", currentUserData.id), { avatar: newAvatar });
              showToast("Avatar Updated!");
          } catch(e) {
              console.error(e);
              showToast("Error updating avatar", "error");
          }
      };

      // --- NAVIGATION ---
      window.showSection = function(id) {
          document.querySelectorAll('#user-views .section').forEach(e => e.classList.add('hidden'));
          document.getElementById(`view-${id}`).classList.remove('hidden');
          
          // Nav Highlight
          document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
          const map = {'market':0, 'wallet':1, 'chat':2, 'profile':3};
          if(map[id] !== undefined) document.querySelectorAll('.nav-item')[map[id]].classList.add('active');
      };

      window.showAdminSection = function(id) {
          document.querySelectorAll('#admin-views .section').forEach(e => e.classList.add('hidden'));
          document.getElementById(`view-admin-${id}`).classList.remove('hidden');
          
          if(id === 'deposits') loadAdminDeposits();
          if(id === 'users') loadAdminUsers();
          if(id === 'chat') loadAdminChatList();
      };

      // --- ACTIONS ---

      // 1. Deposit
      window.updateDepositDetails = function() {
          const method = document.getElementById('deposit-method').value;
          const numDisplay = document.getElementById('deposit-number');
          const nameDisplay = document.getElementById('deposit-name');
          
          if(method === 'easypaisa') { numDisplay.innerText = "0300-1234567"; nameDisplay.innerText = "Ali Khan - Easypaisa"; }
          else if(method === 'jazzcash') { numDisplay.innerText = "0321-7654321"; nameDisplay.innerText = "Ali Khan - JazzCash"; }
          else { numDisplay.innerText = "T9y...XYZ"; nameDisplay.innerText = "USDT (TRC20)"; }
          window.calculateDeposit();
      };

      window.calculateDeposit = function() {
          const pkr = parseFloat(document.getElementById('deposit-amount').value) || 0;
          const usdtRate = parseFloat(document.getElementById('rate-usdt').innerText) || 280;
          const receive = pkr / usdtRate;
          document.getElementById('deposit-calc-receive').innerText = receive.toFixed(2);
      };

      window.copyDepositNumber = function() {
          const num = document.getElementById('deposit-number').innerText;
          navigator.clipboard.writeText(num);
          showToast("Number Copied!");
      };

      window.submitDeposit = async function() {
          const amount = parseFloat(document.getElementById('deposit-amount').value);
          const ref = document.getElementById('deposit-ref').value;
          const method = document.getElementById('deposit-method').value;
          
          if (!amount || amount < 100) return showToast("Minimum deposit 100 PKR", "error");
          if (!ref) return showToast("Enter Transaction ID", "error");

          const usdtRate = parseFloat(document.getElementById('rate-usdt').innerText) || 280;
          const receiveTk = amount / usdtRate;

          try {
              await addDoc(collection(db, "transactions"), {
                  userId: currentUserData.id,
                  userEmail: currentUserData.email,
                  type: 'deposit',
                  method: method,
                  amount: receiveTk.toFixed(2),
                  ref: ref,
                  status: 'pending',
                  timestamp: serverTimestamp()
              });
              showToast("Deposit Request Submitted!");
              window.showSection('wallet');
          } catch(e) { showToast(e.message, "error"); }
      };

      // 2. Withdraw
      window.submitWithdraw = async function() {
          const amount = parseFloat(document.getElementById('withdraw-amount').value);
          const method = document.getElementById('withdraw-method').value;
          const account = document.getElementById('withdraw-account').value;

          if (!amount || amount < 50) return showToast("Min withdraw 50 TK", "error");
          if (!account) return showToast("Enter account details", "error");

          const feeRate = currentUserData.isPremium ? 0 : 0.05;
          const fee = amount * feeRate;
          const total = amount + fee;

          if (total > currentUserData.balanceTK) return showToast("Insufficient balance including fee", "error");

          try {
              // Add Request (Pending). Balance deduction happens on APPROVAL.
              await addDoc(collection(db, "transactions"), {
                  userId: currentUserData.id,
                  userEmail: currentUserData.email,
                  type: 'withdraw',
                  method: method,
                  account: account,
                  amount: amount,
                  fee: fee,
                  status: 'pending',
                  timestamp: serverTimestamp()
              });
              showToast("Withdrawal Requested!");
              window.showSection('wallet');
          } catch(e) { showToast(e.message, "error"); }
      };

      // 3. Transfer
      window.submitTransfer = async function() {
          const email = document.getElementById('transfer-email').value;
          const amount = parseFloat(document.getElementById('transfer-amount').value);

          if (!email || email === currentUserData.email) return showToast("Invalid email", "error");
          if (!amount || amount <= 0) return showToast("Invalid amount", "error");
          if (amount > currentUserData.balanceTK) return showToast("Insufficient balance", "error");

          // Find Receiver
          const q = query(collection(db, "users"), where("email", "==", email));
          const snap = await getDocs(q);
          
          if (snap.empty) return showToast("User not found", "error");
          const receiverDoc = snap.docs[0];
          
          try {
              // Use Batch for atomicity? Or just update docs. For simplicity, sequential updates.
              await updateDoc(doc(db, "users", currentUserData.id), { balanceTK: increment(-amount) });
              await updateDoc(doc(db, "users", receiverDoc.id), { balanceTK: increment(amount) });
              showToast("Transfer Successful!");
              window.showSection('wallet');
          } catch(e) { showToast(e.message, "error"); }
      };

      // 4. Premium
      window.upgradePremium = async function() {
          if (currentUserData.balanceTK >= 100) {
              try {
                  await updateDoc(doc(db, "users", currentUserData.id), {
                      balanceTK: increment(-100),
                      isPremium: true
                  });
                  showToast("Upgraded to Premium!");
              } catch(e) { showToast(e.message, "error"); }
          } else {
              showToast("Need 100 TK", "error");
          }
      };

      // 5. Chat
      function loadUserChat(uid) {
          if(unsubscribeChat) unsubscribeChat();
          const chatRef = doc(db, "chats", uid);
          
          unsubscribeChat = onSnapshot(chatRef, (docSnap) => {
              const msgsContainer = document.getElementById('chat-messages');
              msgsContainer.innerHTML = "";
              if(docSnap.exists()) {
                  docSnap.data().messages.forEach(m => {
                      const cls = m.sender === 'admin' ? 'msg-admin' : 'msg-user';
                      msgsContainer.innerHTML += `<div class="message ${cls}">${m.text}</div>`;
                  });
                  msgsContainer.scrollTop = msgsContainer.scrollHeight;
              } else {
                  msgsContainer.innerHTML = `<div style="text-align:center; color:#777; margin-top:20px;">No messages yet.</div>`;
              }
          });
      }

      window.sendChatMessage = async function() {
          const txt = document.getElementById('chat-input').value;
          if(!txt) return;
          
          const chatRef = doc(db, "chats", currentUserData.id);
          // If doc doesn't exist, setDoc first? updateDoc fails if missing.
          // Check existence or use setDoc with merge. 
          // Simpler: arrayUnion works on existing arrays. We assume doc exists or we create it.
          const snap = await getDoc(chatRef);
          if(!snap.exists()) {
              await setDoc(chatRef, { messages: [] });
          }
          
          try {
              await updateDoc(chatRef, {
                  messages: arrayUnion({ sender: 'user', text: txt, time: serverTimestamp() })
              });
              document.getElementById('chat-input').value = "";
          } catch(e) { console.error(e); }
      };

      // --- ADMIN FUNCTIONS ---

      // Market
      window.adminUpdateMarket = async function() {
          const tk = parseFloat(document.getElementById('admin-tk-price').value);
          const usdt = parseFloat(document.getElementById('admin-usdt-rate').value);
          
          try {
              await updateDoc(doc(db, "market", "global"), { tkPrice: tk, usdtRate: usdt });
              showToast("Market Updated");
          } catch(e) { showToast(e.message, "error"); }
      };

      // News
      window.postNews = async function() {
          const headline = document.getElementById('admin-news-headline').value;
          if(!headline) return;
          try {
              await updateDoc(doc(db, "market", "global"), {
                  news: arrayUnion({ title: headline })
              });
              document.getElementById('admin-news-headline').value = "";
              showToast("News Posted");
          } catch(e) { showToast(e.message, "error"); }
      };

      // Deposits / Withdrawals List
      async function loadAdminDeposits() {
          const list = document.getElementById('admin-deposit-list');
          const q = query(collection(db, "transactions"), where("status", "==", "pending"), orderBy("timestamp", "desc"));
          
          // Use onSnapshot for realtime admin view
          onSnapshot(q, (snapshot) => {
              list.innerHTML = "";
              if(snapshot.empty) list.innerHTML = "<div style='text-align:center; color:#777;'>No pending requests</div>";
              
              snapshot.forEach(d => {
                  const t = d.data();
                  const icon = t.type === 'deposit' ? 'fa-arrow-down text-green' : 'fa-arrow-up text-danger';
                  
                  list.innerHTML += `
                  <div style="background:#333; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                      <div>
                          <div style="font-weight:bold;">${t.userEmail}</div>
                          <small>${t.type.toUpperCase()} (${t.method || 'N/A'}) - ${t.amount} TK</small>
                      </div>
                      <div>
                          <button class="btn btn-sm" style="background:green" onclick="window.adminProcessReq('${d.id}', '${t.userId}', ${t.amount}, 'approve')"><i class="fas fa-check"></i></button>
                          <button class="btn btn-sm" style="background:red" onclick="window.adminProcessReq('${d.id}', '${t.userId}', 0, 'reject')"><i class="fas fa-times"></i></button>
                      </div>
                  </div>`;
              });
              
              // Update badge count
              document.getElementById('admin-dep-pending-count').innerText = snapshot.size;
          });
      }

      window.adminProcessReq = async function(transId, userId, amount, action) => {
          try {
              const transRef = doc(db, "transactions", transId);
              const userRef = doc(db, "users", userId);
              
              if (action === 'approve') {
                  // Check if it's deposit or withdraw
                  const snap = await getDoc(transRef);
                  const type = snap.data().type;
                  
                  if (type === 'deposit') {
                      await updateDoc(userRef, { balanceTK: increment(amount) });
                  } else {
                      // Withdraw approved -> Deduct balance
                      // Already logic handled: Withdraw request was pending, balance still with user.
                      // Now deduct.
                      await updateDoc(userRef, { balanceTK: increment(-amount) });
                  }
                  
                  await updateDoc(transRef, { status: 'approved' });
                  showToast("Approved");
              } else {
                  await updateDoc(transRef, { status: 'rejected' });
                  showToast("Rejected");
              }
          } catch(e) { showToast(e.message, "error"); }
      };

      // Users List
      async function loadAdminUsers() {
          const list = document.getElementById('admin-user-list');
          const snap = await getDocs(collection(db, "users"));
          let html = "";
          snap.forEach(d => {
              const u = d.data();
              // Don't show admin in list
              if(u.role === 'admin') return;
              
              // Note: Passwords are not accessible in Firebase Auth for security. 
              // Only Email is shown.
              html += `
              <div style="background:#333; padding:10px; margin-bottom:5px; border-radius:5px; display:flex; justify-content:space-between;">
                  <div>
                      <div style="color:var(--primary);">${u.name}</div>
                      <small style="color:#aaa;">${u.email}</small>
                  </div>
                  <div style="text-align:right;">
                      <div>${u.balanceTK.toFixed(2)} TK</div>
                      <small>${u.isPremium ? '<span class="text-blue">Pro</span>' : 'User'}</small>
                  </div>
              </div>`;
          });
          list.innerHTML = html || "No users found.";
      }

      // Admin Chat
      async function loadAdminChatList() {
          const list = document.getElementById('admin-chat-list');
          const snap = await getDocs(collection(db, "chats"));
          let html = "";
          snap.forEach(d => {
              html += `<div style="background:#333; padding:10px; cursor:pointer; margin-bottom:5px; border-radius:5px;" onclick="window.openAdminChat('${d.id}')">Chat ID: ${d.id.substring(0,8)}...</div>`;
          });
          list.innerHTML = html || "No chats available.";
          document.getElementById('admin-chat-window').classList.add('hidden');
      }

      window.openAdminChat = function(uid) {
          currentAdminChatUser = uid;
          document.getElementById('admin-chat-window').classList.remove('hidden');
          
          // Listen to that specific chat
          onSnapshot(doc(db, "chats", uid), (snap) => {
              const msgs = document.getElementById('admin-chat-messages');
              msgs.innerHTML = "";
              if(snap.exists()){
                  snap.data().messages.forEach(m => {
                      const cls = m.sender === 'admin' ? 'msg-admin' : 'msg-user';
                      msgs.innerHTML += `<div class="message ${cls}">${m.text}</div>`;
                  });
                  msgs.scrollTop = msgs.scrollHeight;
              }
          });
      };

      window.adminSendReply = async function() {
          const txt = document.getElementById('admin-chat-input').value;
          if(!txt || !currentAdminChatUser) return;
          
          const chatRef = doc(db, "chats", currentAdminChatUser);
          const snap = await getDoc(chatRef);
          if(!snap.exists()) await setDoc(chatRef, { messages: [] });

          try {
              await updateDoc(chatRef, {
                  messages: arrayUnion({ sender: 'admin', text: txt, time: serverTimestamp() })
              });
              document.getElementById('admin-chat-input').value = "";
          } catch(e) { console.error(e); }
      };

      // --- UTILS ---
      function showToast(msg, type="success") {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          toast.className = 'toast';
          if(type==='error') toast.style.borderLeftColor = 'red';
          toast.innerText = msg;
          container.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
      }

      function drawChart() {
          const canvas = document.getElementById('marketCanvas');
          const ctx = canvas.getContext('2d');
          canvas.width = canvas.parentElement.offsetWidth;
          canvas.height = canvas.parentElement.offsetHeight;
          
          const price = parseFloat(document.getElementById('market-price').innerText) || 1.5;
          
          // Generate random chart based on price
          const points = [];
          let p = price;
          for(let i=0; i<20; i++) {
              points.push(p);
              p = p * (1 + (Math.random() - 0.5) * 0.1);
          }
          points.push(price);
          
          const max = Math.max(...points) * 1.05;
          const min = Math.min(...points) * 0.95;
          const range = max - min;
          const stepX = canvas.width / (points.length - 1);

          ctx.clearRect(0,0, canvas.width, canvas.height);
          ctx.beginPath();
          ctx.strokeStyle = '#ff6600';
          ctx.lineWidth = 3;
          
          points.forEach((pt, i) => {
              const x = i * stepX;
              const y = canvas.height - ((pt - min) / range) * canvas.height;
              if(i===0) ctx.moveTo(x, y);
              else ctx.lineTo(x, y);
          });
          ctx.stroke();
      }

      window.showAboutModal = function() {
          const modalHtml = `
          <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; display:flex; justify-content:center; align-items:center;">
              <div style="background:var(--bg-card); padding:20px; border-radius:10px; max-width:90%; width:300px; border:1px solid var(--primary); text-align:center;">
                  <h3 class="text-orange">About TK Coin</h3>
                  <p style="margin:10px 0; color:#ccc;">Version 2.0<br>Firebase Powered.<br>Secure & Fast.</p>
                  <button class="btn" onclick="this.parentElement.parentElement.remove()">Close</button>
              </div>
          </div>`;
          document.body.insertAdjacentHTML('beforeend', modalHtml);
      }
      
      // Initial calls
      window.updateDepositDetails();
    </script>
</body>
</html>
