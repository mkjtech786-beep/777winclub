<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Coin - Trading & Wallet App (Fixed)</title>
    <style>
        :root {
            --primary: #ff6600;
            --primary-dark: #cc5200;
            --bg-dark: #121212;
            --bg-card: #1e1e1e;
            --text-light: #e0e0e0;
            --text-muted: #a0a0a0;
            --success: #00c853;
            --danger: #ff3d00;
            --blue: #2979ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow-x: hidden;
            padding-bottom: 70px;
        }

        .hidden { display: none !important; }
        .text-orange { color: var(--primary); }
        .text-blue { color: var(--blue); }
        .text-green { color: var(--success); }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: 0.2s;
        }
        .btn:hover { background: var(--primary-dark); }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; width: auto; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            background: #2a2a2a;
            border: 1px solid #333;
            color: white;
            border-radius: 6px;
            outline: none;
        }
        .input-group input:focus { border-color: var(--primary); }

        /* --- Toast Notification --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--primary);
            color: white;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- Auth Screen --- */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #121212, #2a1b0d);
        }
        .auth-box {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            border-top: 3px solid var(--primary);
        }
        .auth-toggle { text-align: center; margin-top: 15px; font-size: 0.9rem; cursor: pointer; color: var(--primary); }

        /* --- Main Layout --- */
        header {
            background: var(--bg-card);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; background: #333; object-fit: cover; }
        
        /* --- Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--bg-card);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
            z-index: 100;
        }
        .nav-item {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }

        /* --- Sections --- */
        .section { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* Market Chart */
        .chart-container {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            position: relative;
            height: 200px;
            border: 1px solid #333;
        }
        #marketCanvas { width: 100%; height: 100%; }
        .ticker-wrap {
            width: 100%;
            background: #000;
            overflow: hidden;
            padding: 8px 0;
            white-space: nowrap;
            border-bottom: 1px solid var(--primary);
        }
        .ticker { display: inline-block; animation: ticker 20s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 20px; font-size: 0.9rem; }
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        /* Wallet Cards */
        .balance-card {
            background: linear-gradient(135deg, var(--primary), #ff9100);
            color: #fff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(255, 102, 0, 0.3);
        }
        .balance-title { font-size: 0.9rem; opacity: 0.9; }
        .balance-amount { font-size: 2rem; font-weight: bold; margin: 5px 0; }
        
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .menu-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #333;
        }
        .menu-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .menu-icon { font-size: 1.5rem; margin-bottom: 10px; display: block; }

        /* Chat */
        .chat-box {
            background: var(--bg-card);
            height: 60vh;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            border: 1px solid #333;
        }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 80%; padding: 8px 12px; border-radius: 10px; font-size: 0.9rem; word-wrap: break-word;}
        .msg-admin { align-self: flex-start; background: #333; color: white; }
        .msg-user { align-self: flex-end; background: var(--primary); color: white; }
        .chat-input-area { padding: 10px; display: flex; gap: 10px; border-top: 1px solid #333; }

        /* Admin Styles */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .admin-table th, .admin-table td { text-align: left; padding: 8px; border-bottom: 1px solid #333; }
        .admin-table th { color: var(--primary); }
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        .status-pending { background: #ff9800; color: black; }
        .status-approved { background: #00c853; color: white; }
        .status-rejected { background: #ff3d00; color: white; }

        .blue-tick { color: #1da1f2; margin-left: 2px; }

    </style>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div id="toast-container"></div>

    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-box">
            <h2 class="text-orange" style="text-align: center; margin-bottom: 20px;">TK Coin Login</h2>
            <form id="auth-form">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="auth-email" required placeholder="admin@app.com">
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="auth-pass" required placeholder="password">
                </div>
                <button type="submit" class="btn" id="auth-btn">Login</button>
            </form>
            <div class="auth-toggle" onclick="toggleAuthMode()">Don't have an account? Signup</div>
            <div style="margin-top: 15px; font-size: 0.8rem; color: #666; text-align: center;">
                Admin: admin@app.com / admin123
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="hidden">
        <div class="ticker-wrap">
            <div class="ticker" id="news-ticker"></div>
        </div>

        <header>
            <div class="logo">
                <i class="fas fa-coins"></i> TK Coin
                <span id="header-premium-badge" class="hidden blue-tick"><i class="fas fa-check-circle"></i></span>
            </div>
            <div class="user-info" onclick="showSection('profile')">
                <div style="text-align: right;">
                    <div id="header-name">User</div>
                    <div id="header-balance" style="color: var(--primary);">0 TK</div>
                </div>
                <img src="https://picsum.photos/seed/user/50/50" class="avatar" id="header-avatar" alt="User">
            </div>
        </header>

        <main id="user-views">
            <!-- Market -->
            <section id="view-market" class="section">
                <div class="balance-card">
                    <div class="balance-title">Current TK Price</div>
                    <div class="balance-amount"><span id="market-price">0.00</span> PKR</div>
                </div>
                
                <div class="chart-container">
                    <canvas id="marketCanvas"></canvas>
                </div>

                <div style="margin-top: 20px;">
                    <h3>News Feed</h3>
                    <div id="news-feed" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;"></div>
                </div>
            </section>

            <!-- Wallet -->
            <section id="view-wallet" class="section hidden">
                <div class="balance-card">
                    <div class="balance-title">Total Balance</div>
                    <div class="balance-amount"><span id="wallet-tk">0</span> TK</div>
                    <div style="font-size: 1rem; opacity: 0.9;"><span id="wallet-pkr">0</span> PKR</div>
                </div>

                <div class="menu-grid">
                    <div class="menu-card" onclick="showSection('deposit')">
                        <span class="menu-icon text-orange"><i class="fas fa-wallet"></i></span>
                        <div>Deposit</div>
                    </div>
                    <div class="menu-card" onclick="showSection('withdraw')">
                        <span class="menu-icon text-green"><i class="fas fa-money-bill-wave"></i></span>
                        <div>Withdraw</div>
                    </div>
                    <div class="menu-card" onclick="showSection('transfer')">
                        <span class="menu-icon text-blue"><i class="fas fa-exchange-alt"></i></span>
                        <div>Transfer</div>
                    </div>
                    <div class="menu-card" onclick="showSection('premium')">
                        <span class="menu-icon" style="color: gold;"><i class="fas fa-crown"></i></span>
                        <div>Pro</div>
                    </div>
                </div>

                <h3>History</h3>
                <div id="transaction-list" style="margin-top: 10px;"></div>
            </section>

            <!-- Deposit -->
            <section id="view-deposit" class="section hidden">
                <h2 class="text-orange">Deposit</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Add USDT to get TK.</p>
                
                <div class="input-group">
                    <label>Method</label>
                    <select id="deposit-method" onchange="updateDepositDetails()">
                        <option value="usdt">USDT (TRC20)</option>
                        <option value="easypaisa">Easypaisa</option>
                        <option value="jazzcash">JazzCash</option>
                    </select>
                </div>

                <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.8rem; color: #aaa;">Deposit To:</div>
                            <div style="font-weight: bold; font-size: 1.1rem;" id="deposit-number">TRC20...</div>
                            <div style="font-size: 0.8rem; color: var(--primary);" id="deposit-name">USDT</div>
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="copyDepositNumber()"><i class="fas fa-copy"></i></button>
                    </div>
                </div>

                <div class="input-group">
                    <label>Amount (USDT)</label>
                    <input type="number" id="deposit-amount" oninput="calculateDeposit()" placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Ref ID</label>
                    <input type="text" id="deposit-ref" placeholder="TRX ID">
                </div>

                <div style="background: #222; padding: 10px; border-radius: 6px; margin-bottom: 20px;">
                    <small>Receive: <strong><span id="deposit-calc-receive">0</span> TK</strong></small>
                </div>

                <button class="btn" onclick="submitDeposit()">Submit</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="showSection('wallet')">Back</button>
            </section>

            <!-- Withdraw -->
            <section id="view-withdraw" class="section hidden">
                <h2 class="text-orange">Withdraw</h2>
                <p style="color: #aaa; margin-bottom: 20px;">Withdraw TK to USDT.</p>

                <div style="background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div>Available: <strong id="withdraw-bal-display">0 TK</strong></div>
                    <div style="font-size: 0.8rem; color: var(--primary);" id="fee-display">Fee: 5%</div>
                </div>

                <div class="input-group">
                    <label>Method</label>
                    <select id="withdraw-method">
                        <option value="usdt">USDT</option>
                        <option value="easypaisa">Easypaisa</option>
                        <option value="jazzcash">JazzCash</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Account / Address</label>
                    <input type="text" id="withdraw-account" placeholder="Details...">
                </div>
                <div class="input-group">
                    <label>Amount (TK)</label>
                    <input type="number" id="withdraw-amount" placeholder="Min 50" oninput="calculateWithdraw()">
                </div>
                
                <div style="background: #222; padding: 10px; border-radius: 6px; margin-bottom: 20px; color: #aaa;">
                    <small>Receive: <strong style="color: white;"><span id="withdraw-calc-usdt">0.00</span> USDT</strong></small>
                </div>

                <button class="btn" onclick="submitWithdraw()">Request</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="showSection('wallet')">Back</button>
            </section>

            <!-- Transfer -->
            <section id="view-transfer" class="section hidden">
                <h2 class="text-orange">Transfer</h2>
                <div class="input-group">
                    <label>Receiver Email</label>
                    <input type="email" id="transfer-email" placeholder="user@email.com">
                </div>
                <div class="input-group">
                    <label>Amount (TK)</label>
                    <input type="number" id="transfer-amount" placeholder="Amount">
                </div>
                <button class="btn" onclick="submitTransfer()">Send</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="showSection('wallet')">Back</button>
            </section>

            <!-- Premium -->
            <section id="view-premium" class="section hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2>Go Premium</h2>
                    <p>Cost: 100 TK</p>
                </div>
                <div class="balance-card" style="text-align: center;">
                    <div class="balance-amount">100 TK</div>
                    <div>0% Fee + Blue Tick</div>
                </div>
                <button class="btn" onclick="upgradePremium()">Upgrade Now</button>
                <button class="btn btn-outline" style="margin-top: 10px;" onclick="showSection('wallet')">Back</button>
            </section>

            <!-- Chat -->
            <section id="view-chat" class="section hidden">
                <h2>Support</h2>
                <div class="chat-box">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chat-input" placeholder="Type..." style="flex: 1; background: #333; border: none; color: white; padding: 8px; border-radius: 4px;">
                        <button class="btn btn-sm" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </section>

            <!-- Profile -->
            <section id="view-profile" class="section hidden">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="https://picsum.photos/seed/user/100/100" class="avatar" style="width: 100px; height: 100px;" id="profile-avatar">
                    <h2 id="profile-name">User</h2>
                    <p id="profile-email" style="color: #aaa;">email</p>
                    <div id="profile-status" style="margin-top: 5px; font-size: 0.9rem; color: var(--primary);">Standard</div>
                </div>
                <button class="btn" style="background: #333;" onclick="logout()">Logout</button>
            </section>
        </main>

        <!-- Admin Views -->
        <main id="admin-views" class="hidden">
            <section id="view-admin-dashboard" class="section">
                <h2 class="text-orange">Admin Dashboard</h2>
                <div class="menu-grid" style="margin-top: 20px;">
                    <div class="menu-card" onclick="showAdminSection('market')">
                        <span class="menu-icon text-orange"><i class="fas fa-chart-line"></i></span>
                        <div>Market</div>
                    </div>
                    <div class="menu-card" onclick="showAdminSection('deposits')">
                        <span class="menu-icon text-green"><i class="fas fa-check-double"></i></span>
                        <div>Deposits <span id="admin-dep-pending-count" class="badge" style="background:red; padding:2px 5px; border-radius:50%; font-size:0.7rem; color:white;">0</span></div>
                    </div>
                    <div class="menu-card" onclick="showAdminSection('users')">
                        <span class="menu-icon text-blue"><i class="fas fa-users"></i></span>
                        <div>Users</div>
                    </div>
                    <div class="menu-card" onclick="showAdminSection('news')">
                        <span class="menu-icon"><i class="fas fa-newspaper"></i></span>
                        <div>News</div>
                    </div>
                </div>
                <div class="menu-card" onclick="showAdminSection('chat')" style="text-align: left; margin-bottom: 20px;">
                    <span class="menu-icon"><i class="fas fa-comments"></i></span>
                    <div>Chats</div>
                </div>
            </section>

            <!-- Admin Market -->
            <section id="admin-market" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Market Control</h3>
                
                <div class="input-group">
                    <label>TK Price (USDT) - Internal</label>
                    <input type="number" id="admin-tk-price" step="0.01">
                </div>
                
                <div class="input-group">
                    <label>USDT to PKR Rate</label>
                    <input type="number" id="admin-usdt-rate" step="1">
                </div>

                <button class="btn" onclick="adminUpdateMarket()">Update Price</button>
            </section>

            <!-- Admin Deposits -->
            <section id="admin-deposits" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Deposits</h3>
                <table class="admin-table">
                    <thead>
                        <tr><th>User</th><th>Amount</th><th>Action</th></tr>
                    </thead>
                    <tbody id="admin-deposit-list"></tbody>
                </table>
            </section>

            <!-- Admin Users -->
            <section id="admin-users" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Users</h3>
                <table class="admin-table">
                    <thead>
                        <tr><th>Name</th><th>Email</th><th>Balance</th></tr>
                    </thead>
                    <tbody id="admin-user-list"></tbody>
                </table>
            </section>
            
            <!-- Admin News -->
            <section id="admin-news" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Post News</h3>
                <div class="input-group">
                    <label>Headline</label>
                    <input type="text" id="admin-news-headline">
                </div>
                <button class="btn" onclick="postNews()">Post</button>
            </section>

            <!-- Admin Chat -->
             <section id="admin-chat" class="section hidden">
                <button class="btn btn-sm btn-outline" onclick="showAdminSection('dashboard')">Back</button>
                <h3 class="text-orange" style="margin-top: 15px;">Chats</h3>
                <div id="admin-chat-list"></div>
                <div id="admin-chat-window" class="chat-box hidden">
                     <div class="chat-messages" id="admin-chat-messages"></div>
                     <div class="chat-input-area">
                         <input type="text" id="admin-chat-input" placeholder="Reply...">
                         <button class="btn btn-sm" onclick="adminSendReply()">Reply</button>
                     </div>
                </div>
            </section>
        </main>

        <nav class="bottom-nav" id="user-nav">
            <a class="nav-item active" onclick="showSection('market')"><i class="fas fa-chart-line"></i><span>Market</span></a>
            <a class="nav-item" onclick="showSection('wallet')"><i class="fas fa-wallet"></i><span>Wallet</span></a>
            <a class="nav-item" onclick="showSection('chat')"><i class="fas fa-comment-dots"></i><span>Chat</span></a>
            <a class="nav-item" onclick="showSection('profile')"><i class="fas fa-user"></i><span>Profile</span></a>
        </nav>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBMk5ED0YNL9MqVThgMhoOuWvGwTgCJCg",
            authDomain: "injector-c964a.firebaseapp.com",
            databaseURL: "https://injector-c964a-default-rtdb.firebaseio.com",
            projectId: "injector-c964a",
            storageBucket: "injector-c964a.firebasestorage.app",
            messagingSenderId: "746006402839",
            appId: "1:746006402839:web:26d14a3fee7d6e6cc68952",
            measurementId: "G-DBMSEZZWW1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- GLOBALS ---
        let currentUserData = null;
        let marketData = { tkPrice: 1.50, usdtRate: 280 };
        let appSettings = { easypaisa: '0300-1234567', jazzcash: '0321-7654321', usdt: 'TRC20...', minWithdraw: 50, withdrawFee: 0.05 };
        let adminSelectedChatUser = null;
        let chartAnimId = null; // For visual animation

        // --- UTILS ---
        window.showToast = (msg, type = 'success') => {
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--primary)';
            t.innerText = msg;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // --- AUTH ---
        let isSignup = false;
        window.toggleAuthMode = () => {
            isSignup = !isSignup;
            document.querySelector('.auth-box h2').innerText = isSignup ? "Signup" : "Login";
            document.getElementById('auth-btn').innerText = isSignup ? "Signup" : "Login";
        };

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('auth-btn');
            btn.innerText = "Processing..."; btn.disabled = true;
            try {
                if (isSignup) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) { showToast(err.message, "error"); }
            finally { btn.innerText = isSignup ? "Signup" : "Login"; btn.disabled = false; }
        });

        window.logout = () => signOut(auth).then(() => showToast("Logged out"));

        // --- INIT ---
        function initApp() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const userRef = ref(db, 'users/' + user.uid);
                    get(userRef).then(snap => {
                        if (snap.exists()) {
                            currentUserData = snap.val();
                            currentUserData.uid = user.uid;
                            loginSuccess();
                        } else {
                            const isAdmin = user.email === "admin@app.com";
                            const newUser = {
                                name: user.email.split('@')[0], email: user.email, role: isAdmin?"admin":"user",
                                isPremium: isAdmin, balanceTK: isAdmin?10000:0,
                                avatar: `https://picsum.photos/seed/${user.uid}/50/50`
                            };
                            set(userRef, newUser).then(() => {
                                currentUserData = newUser;
                                currentUserData.uid = user.uid;
                                loginSuccess();
                            });
                        }
                    });
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                    currentUserData = null;
                }
            });

            // Market Listener
            onValue(ref(db, 'market'), (snap) => {
                const d = snap.val();
                if (d) {
                    marketData = d;
                    updateMarketUI();
                    updateUI();
                }
            });

            // Settings
            onValue(ref(db, 'settings'), (snap) => { if(snap.val()) appSettings = snap.val(); });
            
            // News
            onValue(ref(db, 'news'), (snap) => {
                const list = document.getElementById('news-feed');
                const ticker = document.getElementById('news-ticker');
                list.innerHTML = ""; ticker.innerHTML = "";
                const d = snap.val();
                if(d) {
                    Object.values(d).reverse().forEach(n => {
                        list.innerHTML += `<div style="background:var(--bg-card); padding:10px; border-radius:6px; border:1px solid #333; margin-bottom:5px;"><b>${n.title}</b><br><small>${n.date}</small></div>`;
                        ticker.innerHTML += `<span class="ticker-item">${n.title}</span>`;
                    });
                }
            });
        }

        function loginSuccess() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            onValue(ref(db, 'users/' + currentUserData.uid), (snap) => {
                currentUserData = snap.val();
                updateUI();
            });

            if (currentUserData.role === 'admin') {
                document.getElementById('user-nav').classList.add('hidden');
                document.getElementById('user-views').classList.add('hidden');
                document.getElementById('admin-views').classList.remove('hidden');
                showAdminSection('dashboard');
            } else {
                document.getElementById('user-nav').classList.remove('hidden');
                document.getElementById('user-views').classList.remove('hidden');
                document.getElementById('admin-views').classList.add('hidden');
                showSection('market');
            }
        }

        // --- NAVIGATION ---
        window.showSection = (id) => {
            document.querySelectorAll('#user-views .section').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            if(id==='wallet') loadUserHistory();
            if(id==='chat') loadUserChat();
        };

        window.showAdminSection = (id) => {
            document.querySelectorAll('#admin-views .section').forEach(e => e.classList.add('hidden'));
            if(id==='dashboard') document.getElementById('view-admin-dashboard').classList.remove('hidden');
            else document.getElementById('admin-'+id).classList.remove('hidden');
            
            if(id==='deposits') loadAdminDeposits();
            if(id==='users') loadAdminUsers();
            if(id==='chat') loadAdminChatList();
        };

        // --- UI ---
        function updateUI() {
            if (!currentUserData) return;
            document.getElementById('header-name').innerText = currentUserData.name;
            document.getElementById('header-balance').innerText = currentUserData.balanceTK.toFixed(2) + " TK";
            document.getElementById('wallet-tk').innerText = currentUserData.balanceTK.toFixed(2);
            document.getElementById('wallet-pkr').innerText = (currentUserData.balanceTK * marketData.tkPrice * marketData.usdtRate).toFixed(2);
            document.getElementById('profile-name').innerText = currentUserData.name;
            document.getElementById('profile-email').innerText = currentUserData.email;
            
            const fee = currentUserData.isPremium ? 0 : appSettings.withdrawFee * 100;
            document.getElementById('fee-display').innerText = `Fee: ${fee}%`;
            document.getElementById('withdraw-bal-display').innerText = currentUserData.balanceTK.toFixed(2) + " TK";
        }

        function updateMarketUI() {
            const pkr = marketData.tkPrice * marketData.usdtRate;
            document.getElementById('market-price').innerText = pkr.toFixed(2);

            // FIX: Only update input if user is NOT typing in it
            const priceInput = document.getElementById('admin-tk-price');
            const rateInput = document.getElementById('admin-usdt-rate');
            
            if (priceInput && document.activeElement !== priceInput) priceInput.value = marketData.tkPrice;
            if (rateInput && document.activeElement !== rateInput) rateInput.value = marketData.usdtRate;
        }

        // --- ADMIN FUNCTIONS ---
        window.adminUpdateMarket = () => {
            const p = parseFloat(document.getElementById('admin-tk-price').value);
            const r = parseFloat(document.getElementById('admin-usdt-rate').value);
            if (isNaN(p) || isNaN(r)) return showToast("Invalid inputs", "error");

            update(ref(db, 'market'), {
                tkPrice: p,
                usdtRate: r,
                mode: 'manual'
            }).then(() => showToast("Price Updated!"));
        };

        window.postNews = () => {
            const t = document.getElementById('admin-news-headline').value;
            if(t) { push(ref(db, 'news'), { title: t, date: new Date().toLocaleDateString() }); document.getElementById('admin-news-headline').value=''; showToast("Posted"); }
        };

        function loadAdminDeposits() {
            onValue(ref(db, 'deposits'), (snap) => {
                const tbody = document.getElementById('admin-deposit-list');
                tbody.innerHTML = "";
                const d = snap.val();
                if(d) {
                    Object.entries(d).reverse().forEach(([k, v]) => {
                        if (v.status === 'pending') {
                            tbody.innerHTML += `<tr><td>${v.userEmail}</td><td>${v.amount.toFixed(2)} TK</td><td><button class="btn-sm" style="background:green; color:white;" onclick="handleDep('${k}', 'approved')">âœ”</button></td></tr>`;
                        }
                    });
                } else tbody.innerHTML = "<tr><td colspan='3'>No pending</td></tr>";
            });
        }

        window.handleDep = (k, s) => {
            get(ref(db, 'deposits/'+k)).then(snap => {
                const d = snap.val();
                if(d && d.status === 'pending') {
                    update(ref(db, 'deposits/'+k), { status: s });
                    if(s==='approved') {
                        get(ref(db, 'users/'+d.userId+'/balanceTK')).then(uSnap => {
                            const cur = uSnap.val() || 0;
                            set(ref(db, 'users/'+d.userId+'/balanceTK'), cur + parseFloat(d.amount));
                        });
                    }
                }
            });
        };

        function loadAdminUsers() {
            onValue(ref(db, 'users'), (snap) => {
                const tbody = document.getElementById('admin-user-list');
                tbody.innerHTML = "";
                const d = snap.val();
                if(d) Object.values(d).forEach(u => { tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td>${u.balanceTK.toFixed(2)}</td></tr>`; });
            });
        }

        // --- CHART ANIMATION (VISUAL ONLY) ---
        // This function runs purely in the browser to create the zigzag effect
        // without changing the database price.
        function startVisualChart() {
            const canvas = document.getElementById('marketCanvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            let offset = 0;

            function draw() {
                // Resize if needed
                canvas.width = canvas.parentElement.offsetWidth;
                canvas.height = canvas.parentElement.offsetHeight;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath();
                ctx.strokeStyle = '#ff6600';
                ctx.lineWidth = 2;

                const centerY = canvas.height / 2;
                const amplitude = 20; // Height of zigzag

                for (let x = 0; x < canvas.width; x+=5) {
                    // Create a sine wave + random noise
                    // Time-based offset creates movement
                    const y = centerY + Math.sin((x + offset) * 0.05) * amplitude + (Math.random()-0.5)*5;
                    if(x===0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();

                offset += 2; // Move the wave
                requestAnimationFrame(draw);
            }
            draw();
        }

        // Start animation when market view is visible
        const marketObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (!document.getElementById('view-market').classList.contains('hidden')) {
                    startVisualChart();
                }
            });
        });
        marketObserver.observe(document.getElementById('view-market'), { attributes: true });


        // --- USER WALLET FUNCTIONS ---
        window.updateDepositDetails = () => {
            const m = document.getElementById('deposit-method').value;
            const num = document.getElementById('deposit-number');
            const name = document.getElementById('deposit-name');
            if(m==='usdt') { num.innerText=appSettings.usdt; name.innerText='USDT'; }
            else if(m==='easypaisa') { num.innerText=appSettings.easypaisa; name.innerText='Easypaisa'; }
            else { num.innerText=appSettings.jazzcash; name.innerText='JazzCash'; }
            calculateDeposit();
        };

        window.calculateDeposit = () => {
            const val = parseFloat(document.getElementById('deposit-amount').value) || 0;
            const rec = val / marketData.tkPrice;
            document.getElementById('deposit-calc-receive').innerText = rec.toFixed(2);
        };

        window.copyDepositNumber = () => {
            navigator.clipboard.writeText(document.getElementById('deposit-number').innerText);
            showToast("Copied");
        };

        window.submitDeposit = () => {
            const amt = parseFloat(document.getElementById('deposit-amount').value);
            const ref = document.getElementById('deposit-ref').value;
            const m = document.getElementById('deposit-method').value;
            if(!amt || amt<=0 || !ref) return showToast("Invalid details", "error");
            
            let rAmt = 0, raw = 0;
            if(m==='usdt') { raw=amt; rAmt=raw/marketData.tkPrice; }
            else { const usd = amt/marketData.usdtRate; raw=usd; rAmt=usd/marketData.tkPrice; }

            push(ref(db, 'deposits'), {
                userId: currentUserData.uid, userEmail: currentUserData.email, method: m,
                amount: rAmt, rawAmount: raw, ref: ref, date: new Date().toLocaleString(), status: 'pending'
            }).then(() => { showToast("Submitted"); showSection('wallet'); });
        };

        window.calculateWithdraw = () => {
            const amt = parseFloat(document.getElementById('withdraw-amount').value) || 0;
            document.getElementById('withdraw-calc-usdt').innerText = (amt * marketData.tkPrice).toFixed(2);
        };

        window.submitWithdraw = () => {
            const amt = parseFloat(document.getElementById('withdraw-amount').value);
            const acc = document.getElementById('withdraw-account').value;
            const m = document.getElementById('withdraw-method').value;
            if(!amt || amt < appSettings.minWithdraw || !acc) return showToast("Check details", "error");

            const feeRate = currentUserData.isPremium ? 0 : appSettings.withdrawFee;
            const fee = amt * feeRate;
            const tot = amt + fee;
            
            if(tot > currentUserData.balanceTK) return showToast("Insufficient balance", "error");

            const k = push(child(ref(db), 'withdrawals')).key;
            const up = {};
            up['users/'+currentUserData.uid+'/balanceTK'] = currentUserData.balanceTK - tot;
            up['withdrawals/'+k] = { userId: currentUserData.uid, userEmail: currentUserData.email, method: m, account: acc, amount: amt, fee: fee, date: new Date().toLocaleString(), status: 'pending' };
            
            update(ref(db), up).then(() => { showToast("Requested"); showSection('wallet'); });
        };

        window.submitTransfer = () => {
            const em = document.getElementById('transfer-email').value;
            const amt = parseFloat(document.getElementById('transfer-amount').value);
            if(!em || em===currentUserData.email || !amt || amt<=0) return showToast("Invalid details", "error");
            if(amt > currentUserData.balanceTK) return showToast("Insufficient balance", "error");

            get(ref(db, 'users')).then(snap => {
                let rId = null;
                if(snap.exists()) snap.forEach(c => { if(c.val().email === em) rId = c.key; });
                if(rId) {
                    const up = {};
                    up['users/'+currentUserData.uid+'/balanceTK'] = currentUserData.balanceTK - amt;
                    up['users/'+rId+'/balanceTK'] = (snap.val()[rId].balanceTK||0) + amt;
                    update(ref(db), up).then(() => { showToast("Sent"); showSection('wallet'); });
                } else showToast("User not found", "error");
            });
        };

        window.upgradePremium = () => {
            if(currentUserData.balanceTK >= 100) {
                update(ref(db, 'users/'+currentUserData.uid), { balanceTK: currentUserData.balanceTK-100, isPremium: true }).then(()=>showToast("Upgraded"));
            } else showToast("Need 100 TK", "error");
        };

        // --- CHATS ---
        function loadUserChat() {
            onValue(ref(db, 'chats/'+currentUserData.uid), (snap) => {
                const div = document.getElementById('chat-messages');
                div.innerHTML = "";
                const d = snap.val();
                if(!d) div.innerHTML = `<div style="text-align:center; color:#777;">Start chatting</div>`;
                else Object.values(d).forEach(m => {
                    const cls = m.sender==='admin'?'msg-admin':'msg-user';
                    div.innerHTML += `<div class="message ${cls}">${m.text}</div>`;
                });
                div.scrollTop = div.scrollHeight;
            });
        }
        window.sendChatMessage = () => {
            const t = document.getElementById('chat-input').value;
            if(!t) return;
            push(ref(db, 'chats/'+currentUserData.uid), { sender:'user', text:t, time:Date.now() });
            document.getElementById('chat-input').value = "";
        };

        function loadAdminChatList() {
            const div = document.getElementById('admin-chat-list');
            div.innerHTML = "Loading...";
            onValue(ref(db, 'chats'), (snap) => {
                div.innerHTML = "";
                const d = snap.val();
                if(!d) { div.innerHTML="No chats"; return; }
                Object.keys(d).forEach(uid => {
                    get(ref(db, 'users/'+uid)).then(uSnap => {
                        const e = uSnap.exists()?uSnap.val().email:uid;
                        const b = document.createElement('button');
                        b.className = "btn btn-outline"; b.style.marginBottom="5px"; b.style.textAlign="left";
                        b.innerHTML = e;
                        b.onclick = () => { adminSelectedChatUser = uid; document.getElementById('admin-chat-window').classList.remove('hidden'); loadAdminChatMsgs(uid); };
                        div.appendChild(b);
                    });
                });
            });
        }
        function loadAdminChatMsgs(uid) {
            onValue(ref(db, 'chats/'+uid), (snap) => {
                const div = document.getElementById('admin-chat-messages');
                div.innerHTML = "";
                const d = snap.val();
                if(d) Object.values(d).forEach(m => {
                    const st = m.sender==='admin'?'align-self:flex-end;background:var(--blue)':'align-self:flex-start;background:#333;';
                    div.innerHTML += `<div class="message" style="${st}">${m.text}</div>`;
                });
                div.scrollTop = div.scrollHeight;
            });
        }
        window.adminSendReply = () => {
            const t = document.getElementById('admin-chat-input').value;
            if(!t) return;
            push(ref(db, 'chats/'+adminSelectedChatUser), { sender:'admin', text:t, time:Date.now() });
            document.getElementById('admin-chat-input').value = "";
        }

        // --- HISTORY ---
        function loadUserHistory() {
            const l = document.getElementById('transaction-list');
            l.innerHTML = "";
            Promise.all([get(ref(db, 'deposits')), get(ref(db, 'withdrawals'))]).then(([dSnap, wSnap]) => {
                let tx = [];
                if(dSnap.exists()) Object.entries(dSnap.val()).forEach(([k,v]) => { if(v.userId===currentUserData.uid) tx.push({t:'dep', d:v, da:new Date(v.date).getTime()}); });
                if(wSnap.exists()) Object.entries(wSnap.val()).forEach(([k,v]) => { if(v.userId===currentUserData.uid) tx.push({t:'wit', d:v, da:new Date(v.date).getTime()}); });
                tx.sort((a,b) => b.da - a.da);
                
                if(tx.length===0) l.innerHTML = "<div style='text-align:center; color:#555;'>No transactions</div>";
                tx.forEach(tx => {
                    const d = tx.d; const isD = tx.t==='dep';
                    l.innerHTML += `
                    <div style="background:var(--bg-card); padding:10px; border-radius:6px; border:1px solid #333; display:flex; justify-content:space-between; margin-bottom:5px;">
                        <div><b>${isD?'Deposit':'Withdrawal'}</b><br><small>${d.date}</small></div>
                        <div style="text-align:right;">
                            <div class="${d.status==='approved'?'text-green':(d.status==='rejected'?'text-danger':'text-orange')}">${isD?'+':'-'}${d.amount.toFixed(2)} TK</div>
                            <small>${d.status.toUpperCase()}</small>
                        </div>
                    </div>`;
                });
            });
        }

        // --- START ---
        initApp();
    </script>
</body>
</html>
