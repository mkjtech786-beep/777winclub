<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Coin - Neon Feed & Live Logs</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #FF8C00;      
            --primary-light: #FFA500; 
            --secondary: #FFD700;    
            --bg-dark: #121212;     
            --bg-panel: #1E1E1E;    
            --text-light: #ffffff;
            --text-gray: #b0b0b0;
            --danger: #ff4d4d;
            --success: #00e676;
            --neon-green: #0f0; /* Matrix Green for logs */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            overflow-x: hidden;
            min-height: 100vh;
            /* Background Grid Pattern */
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.7) 1px, transparent), 
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent);
            background-size: 20px 20px;
            background-position: center;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .center { align-items: center; justify-content: center; }
        .col { flex-direction: column; }
        
        .btn {
            padding: 10px 20px;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: 0.2s;
            box-shadow: 0 0 10px rgba(255, 140, 0, 0.1);
        }
        .btn:hover {
            background: rgba(255, 140, 0, 0.2);
            box-shadow: 0 0 20px rgba(255, 140, 0, 0.3);
            border-color: var(--secondary);
            color: var(--secondary);
        }
        .btn-primary { 
            background: linear-gradient(135deg, var(--secondary), var(--primary)); 
            color: #000; 
            box-shadow: 0 0 15px var(--primary-light);
        }
        .btn-outline { 
            border: 1px solid var(--primary); 
            color: var(--primary); 
            background: transparent; 
            width: 100%;
        }

        /* --- TOAST --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast {
            background: rgba(0, 20, 0, 0.9);
            border-left: 5px solid var(--secondary);
            color: white;
            padding: 10px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            animation: slideIn 0.2s ease;
            font-weight: bold;
            font-size: 0.9rem;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- AUTH --- */
        #auth-container {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000000 100%);
        }
        .auth-box {
            width: 100%;
            max-width: 400px;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary);
            border-radius: 16px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--secondary); font-size: 0.9rem; }
        .input-group input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: rgba(0,0,0,0.5);
            color: white;
            outline: none;
            transition: 0.2s;
        }
        .input-group input:focus { border-color: var(--secondary); box-shadow: 0 0 10px var(--secondary); }

        /* --- LAYOUT --- */
        header {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--secondary); text-shadow: 0 0 15px var(--primary-light); }
        .nav-links button {
            background: none;
            border: none;
            color: var(--text-gray);
            margin-left: 15px;
            cursor: pointer;
            font-size: 1rem;
            position: relative;
        }
        .nav-links button.active { color: var(--primary); font-weight: bold; }
        
        /* --- NEWS TICKER --- */
        .news-ticker-wrap {
            width: 100%;
            background: #000;
            border-bottom: 1px solid var(--primary);
            overflow: hidden;
            height: 40px;
            display: flex;
            align-items: center;
        }
        .news-ticker {
            white-space: nowrap;
            animation: ticker 15s linear infinite;
            padding-left: 100%;
            color: var(--secondary);
            font-weight: bold;
            text-shadow: 0 0 10px var(--secondary);
        }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* --- MAIN --- */
        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        @media(min-width: 768px) { main { grid-template-columns: 300px 1fr; } }

        .card {
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }
        .card h3 { 
            margin-bottom: 15px; 
            border-bottom: 1px solid var(--primary); 
            padding-bottom: 10px; 
            color: var(--secondary);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        /* --- FEED STYLES (NEON) --- */
        #page-feed {
            background: radial-gradient(circle at top, #1a1a1a, #000000 100%);
            position: relative;
        }
        
        /* LIVE TRAFFIC HEADER */
        .live-traffic-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid var(--primary);
            background: rgba(255, 140, 0, 0.1);
            border-radius: 4px;
        }
        .blink-dot {
            width: 10px; height: 10px;
            background-color: #f00;
            border-radius: 50%;
            box-shadow: 0 0 10px #f00;
            animation: blinker 1s infinite;
        }
        @keyframes blinker { 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* LOG TERMINAL */
        .log-terminal {
            background: #000;
            border: 1px solid #003300; /* Dark Green Border */
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--neon-green);
            box-shadow: inset 0 0 20px rgba(0, 255, 0, 0.1);
        }
        .log-entry {
            border-bottom: 1px dashed #004d00;
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-time { color: var(--neon-green); margin-right: 10px; font-size: 0.7rem; }

        /* POSTS & E.T.C */
        .post-item {
            background: rgba(20, 20, 20, 0.4);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid #333;
        }
        
        /* SCANLINE (Active Lock) */
        .scanline {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: rgba(255, 0, 0, 0.5);
            animation: scanMove 2s linear infinite;
            z-index: 5;
        }
        @keyframes scanMove {
            0% { top: 0; left: 0; opacity: 0; }
            50% { top: 0; left: 0; opacity: 1; } /* Flash across */
            100% { top: 0; left: 0; opacity: 0; }
        }

        /* Likes */
        .likes-container {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
        }
        .like-btn {
            background: none;
            border: 1px solid #444;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .like-btn:hover {
            border-color: var(--primary);
            background: rgba(255, 140, 0, 0.1);
        }
        .like-btn.liked { color: #ff4d4d; border-color: #ff4d4d; }
        .like-count { font-size: 0.9rem; color: var(--text-gray); font-weight: bold; min-width: 30px; text-align: center;}

        /* BREAKING NEWS */
        .breaking-news-box {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--secondary);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .breaking-news-title {
            color: var(--secondary);
            font-size: 0.9rem;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: pulseText 2s infinite;
        }
        @keyframes pulseText {
            0% { text-shadow: 0 0 10px var(--secondary); }
            50% { text-shadow: 0 0 20px var(--secondary); }
            100% { text-shadow: 0 0 10px var(--secondary); }
        }

        /* --- PROFILE ANIMATIONS --- */
        #page-profile {
            background: linear-gradient(-45deg, #121212, #1a1a1a, #121212);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            position: relative;
            overflow: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .profile-glass-card {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .profile-avatar-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            animation: floatAvatar 3s ease-in-out infinite;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #000;
            box-shadow: 0 0 20px var(--secondary-light);
        }
        @keyframes floatAvatar {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* --- WALLET CARD --- */
        .balance-container {
            text-align: center;
            padding: 20px 0;
            border: 1px dashed #555;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .coin-amt {
            display: block;
            font-size: 3rem;
            font-weight: 900;
            color: var(--secondary);
            line-height: 1;
        }
        .pkr-amt {
            display: block;
            font-size: 1.4rem;
            color: var(--text-gray);
            margin-top: 5px;
            font-weight: 700;
            font-family: 'Courier New', monospace; 
        }
        .today-rates {
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: var(--text-gray);
        }
        .today-rates strong { color: var(--primary); }
        .wallet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* --- MARKET CHART --- */
        canvas#marketChart {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 12px;
            border: 1px solid #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }
        .market-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .coin-price { font-size: 2.5rem; font-weight: bold; color: var(--secondary); text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--bg-panel);
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--primary);
            position: relative;
            animation: popIn 0.2s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-gray);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .method-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .method-tab {
            flex: 1;
            padding: 8px;
            background: #121212;
            border: 1px solid #444;
            color: var(--text-gray);
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: 0.2s;
        }
        .method-tab.active { background: var(--primary); color: #000; border-color: var(--primary); font-weight: bold; }
        .calc-display {
            background: #121212;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: right;
            border: 1px solid #333;
        }
        .calc-display span { display: block; font-size: 0.8rem; color: var(--text-gray); }
        .calc-display strong { font-size: 1.5rem; color: var(--secondary); }

        /* --- CHAT STYLES --- */
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            margin: 10px 0;
            background: #000;
            border-radius: 8px;
            padding: 10px;
            min-height: 200px;
            max-height: 400px;
            border: 1px solid #333;
        }
        .chat-msg {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            font-size: 0.9rem;
            position: relative;
            word-wrap: break-word;
        }
        .msg-user {
            background: #333;
            color: white;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }
        .msg-admin {
            background: var(--primary);
            color: #000;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }
        .msg-bot {
            background: var(--bg-panel);
            border: 1px solid var(--secondary);
            color: var(--secondary);
            font-size: 0.8rem;
            align-self: center;
            width: 100%;
            text-align: center;
            margin: 15px 0;
        }

        /* --- ADMIN SETTINGS --- */
        .admin-control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #121212;
            border-radius: 6px;
        }
        .switch-label { display: flex; align-items: center; gap: 10px; color: var(--text-gray); font-size: 0.9rem; }
        input[type="checkbox"].custom-switch {
            width: 40px;
            height: 20px;
            appearance: none;
            background: #333;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
        }
        input[type="checkbox"].custom-switch:checked { background: var(--primary); }
        input[type="checkbox"].custom-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        input[type="checkbox"].custom-switch:checked::after { left: 22px; }

        /* --- LINKS --- */
        .text-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .text-link:hover { text-decoration: underline; }

        /* --- MOBILE NAV --- */
        @media(max-width: 768px) {
            .desktop-nav { display: none; }
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                background: var(--bg-panel);
                display: flex;
                justify-content: space-around;
                padding: 10px 0;
                border-top: 1px solid var(--primary);
                z-index: 999;
            }
            .mobile-nav button { background: none; border: none; color: var(--text-gray); display: flex; flex-direction: column; align-items: center; font-size: 0.8rem;}
            .mobile-nav button.active { color: var(--secondary); text-shadow: 0 0 10px var(--secondary); }
            .mobile-nav svg { width: 24px; height: 24px; margin-bottom: 4px; }
            main { padding-bottom: 80px; }
        }
        @media(min-width: 769px) { .mobile-nav { display: none; } }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- AUTHENTICATION SECTION -->
    <section id="auth-section">
        <div id="auth-container">
            <div class="auth-box">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="color: var(--secondary); text-shadow: 0 0 20px var(--primary-light);">TK Coin</h1>
                    <p style="color: var(--primary);">Neon Marketplace</p>
                </div>
                <div class="form-toggle flex" style="background: #000; border-radius: 8px; padding: 5px; margin-bottom: 20px;">
                    <div class="toggle-btn flex center col" style="flex:1; height:40px; cursor:pointer;" onclick="switchAuthMode('login')">Login</div>
                    <div class="toggle-btn flex center col" style="flex:1; height:40px; cursor:pointer;" onclick="switchAuthMode('signup')">Sign Up</div>
                </div>

                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="input-group"><label>Email</label><input type="email" id="login-email" required placeholder="admin@tk.com"></div>
                    <div class="input-group"><label>Password</label><input type="password" id="login-password" required placeholder="admin123"></div>
                    <button type="submit" class="btn btn-primary">Login</button>
                    <div style="text-align: center; margin-top: 15px;">
                        <span class="text-link" onclick="openModal('terms')">Terms & Policy</span>
                    </div>
                </form>
                <form id="signup-form" class="hidden" onsubmit="handleSignup(event)">
                    <div class="input-group"><label>Full Name</label><input type="text" id="signup-name" required></div>
                    <div class="input-group"><label>Email</label><input type="email" id="signup-email" required></div>
                    <div class="input-group"><label>Password</label><input type="password" id="signup-password" required></div>
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </form>
            </div>
        </div>
    </section>

    <!-- APP SECTION -->
    <section id="app-section" class="hidden">
        <header>
            <div class="logo">TK Coin <span id="header-blue-tick" class="hidden" style="color:var(--primary);">✓</span></div>
            <nav class="desktop-nav">
                <div class="nav-links">
                    <button onclick="router('market')" id="nav-market">Market</button>
                    <button onclick="router('wallet')" id="nav-wallet">Wallet</button>
                    <button onclick="router('feed')" id="nav-feed">Feed</button>
                    <button onclick="router('profile')" id="nav-profile">Profile</button>
                    <button onclick="router('admin')" id="nav-admin" class="hidden">Admin</button>
                    <button onclick="logout()" style="color: var(--danger);">Logout</button>
                </div>
            </nav>
        </header>

        <div class="news-ticker-wrap">
            <div class="news-ticker" id="news-ticker-content">Welcome to TK Coin Marketplace...</div>
        </div>

        <main>
            <!-- MARKET PAGE -->
            <div id="page-market" class="page-section">
                <div class="card" style="grid-column: 1 / -1;">
                    <div class="market-header">
                        <div><h2>TK / USD</h2><small style="color: var(--text-gray);">Live Market</small></div>
                        <div class="coin-price">$<span id="live-price">0.00</span></div>
                    </div>
                    <canvas id="marketChart"></canvas>
                </div>
            </div>

            <!-- WALLET PAGE -->
            <div id="page-wallet" class="page-section hidden">
                <div class="card">
                    <h3>My Balance</h3>
                    <div class="balance-container">
                        <span class="coin-amt"><span id="user-balance">0.00</span> TK</span>
                        <span class="pkr-amt">≈ Rs. <span id="user-pkr">0.00</span></span>
                    </div>
                    
                    <div class="today-rates">
                        <span>1 TK = $<span id="rate-usdt-display">0.00</span></span>
                        <span>1 TK = Rs. <span id="rate-pkr-display">0.00</span></span>
                    </div>
                    
                    <div class="wallet-actions">
                        <button class="btn btn-primary" onclick="openModal('deposit')">Deposit</button>
                        <button class="btn btn-outline" onclick="openModal('withdraw')">Withdraw</button>
                    </div>
                </div>

                <!-- TRANSFER -->
                <div class="card">
                    <h3>Transfer</h3>
                    <div class="input-group">
                        <label>Receiver Email</label>
                        <input type="email" id="transfer-email" placeholder="friend@email.com">
                    </div>
                    <div class="input-group">
                        <label>Amount (TK)</label>
                        <input type="number" id="transfer-amount" placeholder="0.00">
                    </div>
                    <button class="btn btn-outline" onclick="processTransfer()">Send Coins</button>
                </div>
            </div>

            <!-- FEED PAGE -->
            <div id="page-feed" class="page-section hidden">
                
                <!-- NEW: Breaking News Section -->
                <div class="breaking-news-box">
                    <div class="breaking-news-title">Breaking News</div>
                    <ul style="padding-left: 20px; margin: 0; list-style: none; color: #ccc;">
                        <li style="margin-bottom: 8px;">• TK Coin reaches 1 Million Users</li>
                        <li>• New "Matrix Protocol" update live</li>
                    <li>• Global partnership announced</li>
                    <li>• System maintenance scheduled</li>
                    <li>• Major buy signal detected</li>
                    <li>• Market liquidity increased</li>
                    <li>• Technical analysis: Strong bullish trend</li>
                        <li>• Whales accumulating at 350 PKR</li>
                        <li>• Institutional investors entering market</li>
                    <li>• RSI indicates oversold condition</li>
                    <li>• Resistance broken! Expect upward movement</li>
                        <li>• New withdrawal request processed</li>
                    <li>• System check: All systems operational</li>
                    <li>• Market volatility increasing</li>
                    <li>• Buy signal confirmed by algorithm</li>
                    <li>• Transaction pool updated</li>
                    <li>• Security scan: Passed</li>
                    <li>• Network block: 0 confirmations</li>
                    <li>• New API integration ready</li>
                    <li>• Order filled: BUY 50 TK @ 350</li>
                    <li>• Rate updated to 1.15 USDT</li>
                    <li>• Deposit request approved</li>
                        <li>• User registered</li>
                        <li>• Login successful</li>
                        <li>• Logout event</li>
                        <li>• Balance updated</li>
                        <li>• Profile synced</li>
                        <li>• Token transfer complete</li>
                        <li>• Withdrawal pending</li>
                        <li>• Chat message received</li>
                        <li>• Admin settings saved</li>
                        <li>• Premium upgrade success</li>
                        <li> • User banned</li>
                        <li> • Rate limit adjusted</li>
                        <li> • Drift mode activated</li>
                        <li> • Manual mode active</li>
                        <li> • Auto mode active</li>
                        <li> • News posted</li>
                        <li> • Support reply sent</li>
                        <li> • Chart initialized</li>
                        <li> • Session started</li>
                        <li> • Database connection established</li>
                        <li> • WebSocket connected</li>
                        <li> • Security verified</li>
                        <li> • Network ping: 24ms</li>
                        <li> • Server time synced</li>
                        <li> • Encrypting data...</li>
                        <li> • Hash generated</li>
                        <li >• > • > • > ...</li>
                        <li > • • • > ...</li>
                        <li > • • • > ...</li>
                        <li > • • • > ...</li>
                    </ul>
                </div>

                <!-- LIVE LOGS TERMINAL -->
                <div class="card log-terminal">
                    <div class="flex center" style="justify-content: space-between; margin-bottom: 10px;">
                        <h3 style="color: var(--secondary);">SYSTEM TERMINAL</h3>
                        <div class="flex center">
                            <div class="blink-dot"></div>
                            <span style="font-weight:bold; margin-left: 10px;">LIVE TRAFFIC</span>
                        </div>
                    </div>
                    <div id="feed-logs" style="max-height: 300px; overflow-y: auto;">
                        <!-- Auto generated logs go here -->
                    </div>
                </div>

                <!-- POSTS -->
                <div id="feed-container">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- PROFILE PAGE -->
            <div id="page-profile" class="page-section hidden">
                <!-- UPGRADE CARD -->
                <div class="card premium-card-shimmer profile-glass-card" id="upgrade-card-box" style="text-align: center;">
                    <h3 style="color:var(--secondary); text-shadow: 0 0 5px var(--primary);">Go Premium</h3>
                    <div class="profile-avatar-container">
                        <div class="profile-avatar">⭐</div>
                    </div>
                    <div class="upgrade-price" style="font-size: 2rem; font-weight: bold; color: var(--secondary); margin: 10px 0;">100 TK</div>
                    <ul class="upgrade-features" style="text-align: left; font-size: 0.9rem; color: #ccc; margin-bottom: 15px; list-style: none; padding: 0 20px;">
                        <li style="margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="color: var(--success); margin-right: 10px; font-weight: bold;">✓</span> Zero Withdrawal Fees
                        </li>
                        <li style="margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="color: var(--success); margin-right: 10px; font-weight: bold;">✓</span> Unlock Premium Posts
                        </li>
                        <li style="margin-bottom: 8px; display: flex; align-items: center;">
                            <span style="color: var(--success); margin-right: 10px; font-weight: bold;">✓</span> Blue Tick Verification
                        </li>
                    </ul>
                    <button class="btn btn-primary" onclick="upgradeToPro()" style="background:var(--secondary); color:black; box-shadow: 0 0 15px var(--secondary);">Upgrade Now</button>
                </div>

                <div class="card profile-glass-card">
                    <h3 style="color:var(--primary);">My Profile</h3>
                    
                    <div class="profile-avatar-container" style="margin-bottom: 25px;">
                        <div class="profile-avatar" id="profile-avatar-text">U</div>
                    </div>
                    
                    <div class="profile-info-row" style="text-align: center; margin-bottom: 10px;">
                        <strong style="color: var(--text-gray);">Name: </strong>
                        <span style="color: white; font-weight: bold;" id="profile-name">User</span>
                    </div>
                    <div class="profile-info-row" style="text-align: center;">
                        <strong style="color: var(--text-gray);">Email: </strong>
                        <span style="color: white;" id="profile-email">user@email.com</span>
                    </div>
                    <div class="profile-info-row" style="text-align: center;">
                        <strong style="color: var(--text-gray);">Status: </strong>
                        <span style="color: var(--text-gray);" id="profile-status">Normal</span>
                    </div>

                    <div style="margin-top:25px; display: grid; gap: 10px;">
                        <button class="btn btn-primary" style="background:var(--secondary);" onclick="openModal('chat')">Live Chat</button>
                        <button class="btn btn-outline" onclick="openModal('about')">About Us</button>
                    </div>
                    <div style="margin-top:20px;"><button class="btn btn-primary" onclick="logout()" style="background:var(--danger);">Logout</button></div>
                </div>
                <div class="card profile-glass-card">
                    <h3>History</h3>
                    <div id="history-list" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <!-- ADMIN PAGE -->
            <div id="page-admin" class="page-section hidden" style="grid-column: 1 / -1;">
                <div class="card">
                    <h3>Market Controls</h3>
                    
                    <div class="admin-control-row">
                        <span class="switch-label">
                            <strong>Auto Market Mode</strong>
                            <span style="font-size:0.8rem; color:#888;">(Live Drift)</span>
                        </span>
                        <input type="checkbox" id="admin-auto-rate" class="custom-switch" onchange="toggleAutoRate()">
                    </div>

                    <div id="drift-control" class="admin-control-row hidden">
                        <span class="switch-label">
                            Max Drift (PKR)
                            <span style="font-size:0.8rem; color:#888;">(e.g. 50 Rs up/down)</span>
                        </span>
                        <input type="number" id="admin-drift-limit" value="50" style="width:80px; padding:5px; background:#000; border:1px solid #444; color:white; border-radius:4px;">
                    </div>

                    <hr style="border:0; border-top:1px solid #333; margin:15px 0;">

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <input type="number" id="admin-rate-pkr" placeholder="Rate PKR" style="padding:10px; background:#121212; border:1px solid #444; color:white;" onchange="updateManualSettings()">
                        <input type="number" id="admin-rate-usdt" placeholder="Rate USDT" style="padding:10px; background:#121212; border:1px solid #444; color:white;" onchange="updateManualSettings()">
                        <input type="text" id="admin-deposit-num" placeholder="Deposit #" style="padding:10px; background:#121212; border:1px solid #444; color:white;" onchange="updateSettings()">
                        <input type="number" id="admin-min-withdraw" placeholder="Min Withdraw" style="padding:10px; background:#121212; border:1px solid #444; color:white;" onchange="updateSettings()">
                    </div>
                    <button class="btn btn-primary" style="margin-top:10px;" onclick="postNews()">Post News</button>
                    <input type="text" id="admin-news-input" placeholder="News text..." style="width:100%; margin-top:10px; padding:10px; background:#121212; border:1px solid #444; color:white;">
                </div>

                <div class="card">
                    <h3>Live Support Tickets</h3>
                    <div style="display:grid; grid-template-columns: 1fr 2fr; gap:10px; height: 400px;">
                        <div style="background:#121212; border-radius:8px; overflow-y:auto; border: 1px solid #333;">
                            <div id="admin-chat-users-list" style="padding:5px;">
                                <div style="padding:10px; color:#888; text-align:center;">No Chats Yet</div>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; border: 1px solid #333; border-radius: 8px; background:#000;">
                            <div id="admin-selected-chat-header" style="padding:10px; border-bottom: 1px solid #333; color:var(--secondary); font-weight:bold;">Select a User</div>
                            <div id="admin-chat-display" style="flex:1; padding:10px; overflow-y:auto;"></div>
                            <div style="padding:10px; border-top: 1px solid #333;">
                                <div style="display:flex; gap:10px;">
                                    <input type="text" id="admin-reply-input" placeholder="Type reply..." style="flex:1; padding:8px; background:#121212; border:1px solid #444; color:white; border-radius:4px;">
                                    <button class="btn btn-primary" style="width:auto; padding:5px 15px;" onclick="adminSendReply()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Users</h3>
                    <div style="overflow-x:auto;">
                        <table class="admin-table" style="width:100%; color:white; text-align:left; border-collapse:collapse;">
                            <thead><tr><th>Name</th><th>Role</th><th>Balance</th><th>Action</th></tr></thead>
                            <tbody id="admin-user-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- MOBILE NAV -->
        <nav class="mobile-nav">
            <button onclick="router('market')" id="mob-market"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>Market</button>
            <button onclick="router('wallet')" id="mob-wallet"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>Wallet</button>
            <button onclick="router('feed')" id="mob-feed"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Feed</button>
            <button onclick="router('profile')" id="mob-profile"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Profile</button>
            <button onclick="router('admin')" id="mob-admin" class="hidden"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>Admin</button>
        </nav>
    </section>

    <!-- DEPOSIT MODAL -->
    <div id="deposit-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <button class="modal-close" onclick="closeModal('deposit')">&times;</button>
            <h3 style="color:var(--secondary); margin-bottom:15px; text-align:center;">Deposit Funds</h3>
            <div class="method-tabs">
                <div class="method-tab active" onclick="setDepositMethod('easypaisa')">Easypaisa</div>
                <div class="method-tab" onclick="setDepositMethod('jazzcash')">JazzCash</div>
                <div class="method-tab" onclick="setDepositMethod('usdt')">USDT</div>
            </div>
            <div class="input-group">
                <label>Amount (<span id="deposit-currency-label">PKR</span>)</label>
                <input type="number" id="deposit-amount" oninput="calculateDeposit()" placeholder="0.00">
            </div>
            <div class="input-group">
                <label>Trx ID / Ref</label>
                <input type="text" id="deposit-ref" placeholder="TRX ID...">
            </div>
            <div class="calc-display">
                <span>You will receive</span>
                <strong><span id="deposit-result-tk">0.00</span> TK</strong>
            </div>
            <div style="margin-top:10px; font-size:0.8rem; color:var(--text-gray); display:flex; justify-content:space-between; align-items:center;">
                <span>Send to: <strong id="deposit-number-display" style="color:white;">0300-1234567</strong></span>
                <button class="btn btn-outline" style="width:auto; padding:2px 8px; font-size:0.7rem;" onclick="copyDepositNumber()">Copy</button>
            </div>
            <button class="btn btn-primary" style="margin-top:15px;" onclick="processDeposit()">Confirm</button>
        </div>
    </div>

    <!-- WITHDRAW MODAL -->
    <div id="withdraw-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <button class="modal-close" onclick="closeModal('withdraw')">&times;</button>
            <h3 style="color:var(--secondary); margin-bottom:15px; text-align:center;">Withdraw Funds</h3>
            <div class="method-tabs">
                <div class="method-tab active" onclick="setWithdrawMethod('easypaisa')">Easypaisa</div>
                <div class="method-tab" onclick="setWithdrawMethod('jazzcash')">JazzCash</div>
                <div class="method-tab" onclick="setWithdrawMethod('usdt')">USDT</div>
            </div>
            <div class="input-group">
                <label>Amount (TK)</label>
                <input type="number" id="withdraw-amount" oninput="calculateWithdraw()" placeholder="0.00">
            </div>
            <div class="input-group">
                <label>Account Details</label>
                <input type="text" id="withdraw-dest" placeholder="0300... or Address">
            </div>
            <div class="calc-display">
                <span>You will receive</span>
                <strong><span id="withdraw-result-amount">0.00</span> <span id="withdraw-currency-label">PKR</span></strong>
                <div id="fee-display" style="font-size: 0.9rem; color: var(--text-gray); margin-top: 5px;">Fee: 6%</div>
            </div>
            <button class="btn btn-primary" style="margin-top:15px;" onclick="processWithdraw()">Request</button>
        </div>
    </div>

    <!-- CHAT MODAL (USER) -->
    <div id="chat-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('chat')">&times;</button>
            <h3 style="color:var(--secondary); margin-bottom:15px; text-align:center;">Live Chat</h3>
            <div id="chat-messages"></div>
            <div class="input-group" style="margin-top:10px;">
                <input type="text" id="user-chat-input" placeholder="Type your message...">
            </div>
            <button class="btn btn-primary" onclick="sendUserMessage()">Send</button>
        </div>
    </div>

    <!-- ABOUT MODAL -->
    <div id="about-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('about')">&times;</button>
            <h3 style="color:var(--secondary); margin-bottom:15px; text-align:center;">About TK Coin</h3>
            <p style="color:#ccc; line-height:1.6; font-size:0.9rem;">
                TK Coin is a leading digital currency marketplace designed for fast and secure transactions. 
                We provide a platform for users to trade, invest, and manage their digital assets with ease.
                <br><br>
                Our mission is to make crypto trading accessible to everyone in Pakistan and beyond.
            </p>
        </div>
    </div>

    <!-- TERMS MODAL -->
    <div id="terms-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeModal('terms')">&times;</button>
            <h3 style="color:var(--secondary); margin-bottom:15px; text-align:center;">Terms & Policy</h3>
            <p style="color:#ccc; line-height:1.6; font-size:0.85rem;">
                1. By using TK Coin, you agree to comply with our rules.<br>
                2. All deposits are processed manually via Easypaisa/JazzCash/USDT.<br>
                3. Withdrawal fees apply (6% for normal users, 0% for Pro).<br>
                4. We are not responsible for market losses.<br>
                5. Please do not share your password with anyone.<br>
                6. Fake screenshots for deposits will lead to permanent ban.
            </p>
        </div>
    </div>

    <script>
        /* --- STATE MANAGEMENT --- */
        const DB = {
            users: JSON.parse(localStorage.getItem('tk_users')) || [],
            settings: JSON.parse(localStorage.getItem('tk_settings')) || {
                ratePKR: 350,
                rateUSDT: 1.2,
                depositNum: '0300-1234567',
                minWithdraw: 10,
                autoRate: false,
                driftLimit: 50
            },
            posts: JSON.parse(localStorage.getItem('tk_posts')) || [], // NEW: Store posts here
            news: JSON.parse(localStorage.getItem('tk_news')) || ["Welcome to TK Coin!"],
            history: JSON.parse(localStorage.getItem('tk_history')) || [],
            chats: JSON.parse(localStorage.getItem('tk_chats')) || []
        };
        let currentUser = null;
        let depositMethod = 'easypaisa';
        let withdrawMethod = 'easypaisa';
        let chartInterval = null;
        let rateInterval = null; 
        let feedLogInterval = null; // Interval for feed logs
        let chartPoints = [];
        let selectedAdminChatId = null; 

        // Random Post Data Pool
        const randomPostPool = [
            "Bullish trend detected on TK Coin! Buy now.",
            "Whales accumulating at 350 PKR level.",
            "New support level reached: 1.15 USDT.",
            "Technical analysis: Strong buy signal.",
            "Market volume increasing by 40%.",
            "Breaking: Major partnership announced soon.",
            "Resistances broken! Expect upward movement.",
            "Institutional investors entering market.",
            "RSI indicates oversold condition.",
            "New withdrawal request processed",
            "Market volatility increasing...",
            "Buy signal confirmed by algorithm",
            "Order filled: BUY 50 TK @ 350"
        ];

        // Random Log Messages (More variety now)
        const randomLogs = [
            "Connection secure: 512-bit encryption active.",
            "Order filled: BUY 50 TK @ 350",
            "Rate updated to 1.15 USDT",
            "System check: All systems operational",
            "New withdrawal request processed",
            "Market volatility increasing...",
            "Buy signal confirmed by algorithm",
            "User #882 deposited via Easypaisa",
            "Token transfer successful.",
            "New user registered.",
            "Logout event recorded.",
            "Balance updated.",
            "Settings saved.",
            "Rate limit adjusted.",
            "Drift mode enabled.",
            "Manual mode active.",
            "News posted.",
            "Reply sent.",
            "User banned.",
            "Chart initialized.",
            "Session started.",
            "Websocket connected.",
            "Database connection established.",
            "Security verified.",
            "Network ping: 24ms.",
            "Server time synced.",
            "Encrypting data...",
            "Hash generated.",
            "Order filled: BUY 50 TK @ 350",
            "Order filled: SELL 20 TK @ 340.",
            "User logged in successfully.",
            "API integration ready.",
            "System scan: Passed",
            "User banned successfully.",
            "Drift mode enabled.",
            "Manual mode active.",
            "Auto mode active.",
            "News posted.",
            "Support reply sent.",
            "Upgrade to Pro completed.",
            "Withdraw fee updated.",
            "Token transfer complete.",
            "Session ended.",
            "Connection lost.",
            "Reconnecting...",
            "Data flushed.",
            "Reconnected.",
            "Update received.",
            "Ping: 23ms",
            "Ping: 25ms",
            "Ping: 24ms",
            "Ping: 23ms"
        ];

        window.onload = function() {
            // Ensure Admin exists
            if(!DB.users.find(u => u.email === 'admin@tk.com')) {
                DB.users.push({ id:1, name:'Admin', email:'admin@tk.com', password:'admin123', balance:999999, isPro:true, role:'admin', joined:'2023-01-01', banned:false });
                saveData();
            }
            if(!DB.users.find(u => u.email === 'user@test.com')) {
                DB.users.push({ id:2, name:'Test User', email:'user@test.com', password:'123', balance:50, isPro:false, role:'user', joined:new Date().toISOString().split('T')[0], banned:false });
                saveData();
            }

            const saved = localStorage.getItem('tk_current_session');
            if(saved) {
                currentUser = JSON.parse(saved);
                showApp();
            }
            initChart();
            startChartAnimation(); 
            startRateSimulation(); 
        };

        /* --- AUTH & NAV --- */
        function switchAuthMode(m) {
            if(m==='login') { document.getElementById('login-form').classList.remove('hidden'); document.getElementById('signup-form').classList.add('hidden'); }
            else { document.getElementById('login-form').classList.add('hidden'); document.getElementById('signup-form').classList.remove('hidden'); }
        }
        function handleLogin(e) {
            e.preventDefault();
            const u = DB.users.find(x => x.email === document.getElementById('login-email').value && x.password === document.getElementById('login-password').value);
            if(u) {
                if(u.banned) return showToast('Account Banned', 'error');
                currentUser = u;
                localStorage.setItem('tk_current_session', JSON.stringify(u));
                showApp();
            } else showToast('Invalid credentials', 'error');
        }
        function handleSignup(e) {
            e.preventDefault();
            if(DB.users.find(x => x.email === document.getElementById('signup-email').value)) return showToast('Email taken', 'error');
            const n = {
                id: Date.now(),
                name: document.getElementById('signup-name').value,
                email: document.getElementById('signup-email').value,
                password: document.getElementById('signup-password').value,
                balance: 0, isPro:false, role:'user', joined: new Date().toISOString().split('T')[0], banned:false
            };
            DB.users.push(n);
            saveData();
            showToast('Account created', 'success');
            switchAuthMode('login');
        }
        function logout() {
            if(confirm('Logout?')) {
                currentUser=null;
                localStorage.removeItem('tk_current_session');
                document.getElementById('app-section').classList.add('hidden');
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('auth-container').style.display='flex';
                stopChartAnimation();
                stopRateSimulation();
                stopFeedLog();
            }
        }
        function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('auth-container').style.display='none';
            document.getElementById('app-section').classList.remove('hidden');
            const u = DB.users.find(x => x.id === currentUser.id);
            if(u) currentUser = u;
            
            document.getElementById('header-blue-tick').classList.toggle('hidden', !currentUser.isPro);
            if(currentUser.role==='admin') {
                document.getElementById('nav-admin').classList.remove('hidden');
                document.getElementById('mob-admin').classList.remove('hidden');
            }
            updateDashboard(); 
            renderAdminUI(); 
            router('market');
        }
        function router(p) {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            document.querySelectorAll('.nav-links button, .mobile-nav button').forEach(e => e.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.remove('hidden');
            if(document.getElementById(`nav-${p}`)) document.getElementById(`nav-${p}`).classList.add('active');
            if(document.getElementById(`mob-${p}`)) document.getElementById(`mob-${p}`).classList.add('active');
            if(p==='profile') renderProfile();
            if(p==='admin') {
                renderAdmin();
                renderAdminChats(); 
            }
            if(p==='feed') {
                renderFeed();
                startFeedLog(); 
            } else {
                stopFeedLog(); 
            }
        }

        /* --- LOGIC --- */
        function updateDashboard() {
            const u = DB.users.find(x => x.id === currentUser.id);
            if(u) currentUser = u;
            
            document.getElementById('user-balance').innerText = currentUser.balance.toFixed(2);
            
            const currentPkr = currentUser.balance * DB.settings.ratePKR;
            const pkrEl = document.getElementById('user-pkr');
            pkrEl.innerText = currentPkr.toFixed(2);
            
            document.getElementById('rate-usdt-display').innerText = DB.settings.rateUSDT;
            document.getElementById('rate-pkr-display').innerText = DB.settings.ratePKR;
            document.getElementById('live-price').innerText = DB.settings.rateUSDT;

            document.getElementById('news-ticker-content').innerText = DB.news.join(" +++ ");
        }

        /* --- MARKET SIMULATION (ALREADY RUNNING) --- */
        function initChart() {
            const c = document.getElementById('marketChart');
            c.width = c.parentElement.offsetWidth;
            c.height = 250;
            const h = c.height;
            const m = c.height / 2;

            chartPoints = [];
            // Zigzag pattern
            for(let i=0; i<100; i++) {
                let prevY = i === 0 ? m : chartPoints[i-1];
                let change = (Math.random() - 0.5) * 60; 
                let nextY = prevY + change;
                if(nextY < 10) nextY = 10;
                if(nextY > h - 10) nextY = h - 10;
                chartPoints.push(nextY);
            }
        }
        function startChartAnimation() {
            const c = document.getElementById('marketChart');
            const ctx = c.getContext('2d');
            if(chartInterval) clearInterval(chartInterval);

            chartInterval = setInterval(() => {
                if(!currentUser) return;
                const w = c.width;
                const h = c.height;
                const m = h / 2;

                chartPoints.shift();
                let y = m;
                if(Math.random() > 0.92) y = m - 40; 
                else if (Math.random() > 0.92) y = m + 40;
                else y = m + (Math.random() * 15 - 7.5);
                
                chartPoints.push(y);

                ctx.clearRect(0, 0, w, h);

                // Gradient Area
                const grad = ctx.createLinearGradient(0, 0, 0, h);
                grad.addColorStop(0, 'rgba(255, 140, 0, 0.6)'); 
                grad.addColorStop(1, 'rgba(255, 140, 0, 0.0)'); 

                ctx.beginPath();
                ctx.moveTo(0, h);
                ctx.lineTo(0, chartPoints[0]);
                for(let i=1; i<chartPoints.length; i++) {
                    ctx.lineTo((i/chartPoints.length)*w, chartPoints[i]);
                }
                ctx.lineTo(w, h);
                ctx.closePath();
                ctx.fillStyle = grad;
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(0, chartPoints[0]);
                for(let i=1; i<chartPoints.length; i++) {
                    ctx.lineTo((i/chartPoints.length)*w, chartPoints[i]);
                }
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#FF8C00';
                ctx.stroke();
                ctx.shadowBlur = 0;

            }, 250); 
        }
        function stopChartAnimation() { if(chartInterval) clearInterval(chartInterval); }

        /* --- RATE SIMULATION (SLOW LOGIC) --- */
        function startRateSimulation() {
            if(rateInterval) clearInterval(rateInterval);
            
            rateInterval = setInterval(() => {
                if(!currentUser) return;

                if(DB.settings.autoRate) {
                    const limit = DB.settings.driftLimit || 50;
                    const change = Math.floor(Math.random() * (limit * 2)) - limit; 
                    const actualChange = change / 5; 
                    DB.settings.ratePKR = Math.floor(DB.settings.ratePKR + actualChange);
                    DB.settings.rateUSDT = parseFloat((DB.settings.ratePKR / 280).toFixed(4));
                    if(Math.random() > 0.8) saveData();
                }
                updateDashboard();

            }, 2000); 
        }
        function stopRateSimulation() { if(rateInterval) clearInterval(rateInterval); }

        /* --- MODAL ACTIONS --- */
        function openModal(t) { document.getElementById(`${t}-modal`).style.display = 'flex'; }
        function closeModal(t) { document.getElementById(`${t}-modal`).style.display = 'none'; }
        
        /* --- FEED & LOG LOGIC --- */
        function renderFeed() {
            const container = document.getElementById('feed-container');
            container.innerHTML = '';

            // 1. Breaking News
            const newsBox = document.createElement('div');
            newsBox.className = 'breaking-news-box';
            newsBox.innerHTML = `
                <div class="breaking-news-title">Breaking News</div>
                <ul style="padding-left: 20px; margin: 0; list-style: none; color: #ccc;">
                    <li style="margin-bottom: 8px;">• TK Coin reaches 1 Million Users</li>
                    <li>New "Matrix Protocol" update live</li>
                    <li>• Global partnership announced</li>
                    <li>• Major buy signal detected</li>
                    <li>• Market liquidity increased</li>
                </ul>
            `;
            container.appendChild(newsBox);

            // 2. Random Posts
            const shuffled = [...randomPostPool].sort(() => 0.5 - Math.random());
            const top3 = shuffled.slice(0, 3);

            top3.forEach((postData, index) => {
                const div = document.createElement('div');
                div.className = 'post-item';
                
                const isPro = currentUser.isPro;
                
                div.innerHTML = `
                    <div class="${isPro ? '' : 'locked-content-container'}">
                        ${!isPro ? `
                        <div class="scanline"></div>
                        <div class="locked-overlay">
                            <div class="big-lock-icon">🔒</div>
                            <button class="btn btn-primary" style="padding:5px 10px; font-size:0.7rem; margin-top:10px;" onclick="router('profile')">Upgrade</button>
                        </div>
                        <div class="locked-text" style="padding: 10px;">
                            <strong style="color:var(--secondary);">Market News #${index+1}</strong>
                            <div style="margin-top:5px; color:#666;">${postData}</div>
                        </div>
                    ` : `
                        <strong style="color:var(--secondary);">Market News #${index+1}</strong>
                        <div style="margin-top:10px; color:white;">${postData}</div>
                        <div class="likes-container">
                            <button class="like-btn" onclick="likePost(${index})">
                                <span id="likes-count-${index}">0</span> <span class="like-icon">👍</span>
                            </button>
                        </div>
                    `
                container.appendChild(div);
            });
        }

        // LOG GENERATOR (The "Busy" feel)
        function startFeedLog() {
            stopFeedLog();
            const logContainer = document.getElementById('feed-logs');
            
            feedLogInterval = setInterval(() => {
                const randomLog = randomLogs[Math.floor(Math.random() * randomLogs.length)];
                const time = new Date().toLocaleTimeString();
                
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `<span class="log-time">[${time}]</span> <span>${randomLog}</span>`;
                
                logContainer.prepend(div);
                
                // Keep only last 30 logs
                if(logContainer.children.length > 30) {
                    logContainer.removeChild(logContainer.lastChild);
                }
            }, 2000); 
        }
        function stopFeedLog() {
            if(feedLogInterval) clearInterval(feedLogInterval);
        }

        /* --- LIKE LOGIC --- */
        function likePost(index) {
            // Stop propagation so we don't click the lock or scroll
            event.stopPropagation(); 

            const post = DB.posts[index];
            if(!post) return;

            // Check if already liked
            const liked = currentUser.likedPosts && currentUser.likedPosts.includes(index);
            if(liked) {
                showToast('You already liked this post', 'info');
                return;
            }

            // Logic: Increment like
            post.likes++;
            currentUser.likedPosts.push(index);
            
            // Update Database
            const postIndex = DB.posts.findIndex(p => p.id === index);
            if (postIndex > -1) {
                DB.posts[postIndex].likes = post.likes;
            } else {
                DB.posts[index].likes = 1;
                DB.posts[index].likedPosts = [currentUser.id]; // Track who liked
                DB.posts[index].likedPosts = [...new Set([currentUser.id]); // Initialize array if empty
            }

            saveData();
            showToast('Liked!', 'success');
            
            // Update UI
            renderFeed(); 
        }

        /* --- UPGRADE TO PRO --- */
        function upgradeToPro() {
            const userIndex = DB.users.findIndex(x => x.id === currentUser.id);
            const user = DB.users[userIndex];

            if(user.isPro) {
                return showToast('You are already a Premium User!', 'info');
            }

            if(user.balance < 100) {
                return showToast('Insufficient Balance! Need 100 TK', 'error');
            }

            DB.users[userIndex].balance -= 100;
            DB.users[userIndex].isPro = true;
            
            addHistory(currentUser.id, 'upgrade', 100, 'System', 'Pro Upgrade');
            
            saveData();
            currentUser = DB.users[userIndex]; 
            updateDashboard();
            renderProfile(); 
            showToast('Congratulations! You are now Premium.', 'success');
        }

        /* --- CHAT LOGIC --- */
        function renderUserChat() {
            const list = DB.chats.find(c => c.userId === currentUser.id);
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';

            if(!list || list.messages.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; margin-top:50px;">Start a conversation</div>';
                return;
            }

            list.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'chat-msg';
                if(msg.sender === 'user') {
                    div.classList.add('msg-user');
                    div.innerHTML = `<strong>You:</strong> ${msg.text}`;
                } else {
                    div.classList.add('msg-admin');
                    div.innerHTML = `<strong>Support:</strong> ${msg.text}`;
                }
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function sendUserMessage() {
            const input = document.getElementById('user-chat-input');
            const text = input.value.trim();
            if(!text) return;

            let chat = DB.chats.find(c => c.userId === currentUser.id);
            if(!chat) {
                chat = {
                    id: Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    messages: []
                };
                DB.chats.push(chat);
            }

            chat.messages.push({ sender: 'user', text: text, time: new Date().toISOString() });
            input.value = '';
            saveData();
            renderUserChat();

            setTimeout(() => {
                chat.messages.push({ sender: 'admin', text: 'Wait krne ka khe. JALD HY AAP SE TEAM RABTA KRLEGIII.', time: new Date().toISOString() });
                saveData();
                renderUserChat();
                showToast('New Message Received');
            }, 800);
        }

        /* --- ADMIN CHAT LOGIC --- */
        function renderAdminChats() {
            const list = document.getElementById('admin-chat-users-list');
            list.innerHTML = '';
            
            const activeChats = DB.chats.filter(c => c.userId !== currentUser.id); 
            
            if(activeChats.length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#666; text-align:center;">No Chats</div>';
                return;
            }

            activeChats.forEach(c => {
                const item = document.createElement('div');
                item.style.padding = '10px';
                item.style.borderBottom = '1px solid #333';
                item.style.cursor = 'pointer';
                item.style.color = '#ccc';
                item.innerHTML = `<strong>${c.userName}</strong><br><small style="color:#666;">Last Msg: ${c.messages[c.messages.length-1].text.substring(0,20)}...</small>`;
                item.onclick = () => selectAdminChat(c.id);
                list.appendChild(item);
            });
        }

        function selectAdminChat(chatId) {
            selectedAdminChatId = chatId;
            const chat = DB.chats.find(c => c.id === chatId);
            
            document.getElementById('admin-selected-chat-header').innerText = `Chat with ${chat.userName}`;
            const display = document.getElementById('admin-chat-display');
            display.innerHTML = '';

            chat.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'chat-msg';
                if(msg.sender === 'user') {
                    div.classList.add('msg-user');
                    div.innerHTML = `<strong>${chat.userName}:</strong> ${msg.text}`;
                } else {
                    div.classList.add('msg-admin');
                    div.innerHTML = `<strong>You:</strong> ${msg.text}`;
                }
                display.appendChild(div);
            });
            display.scrollTop = display.scrollHeight;
        }

        function adminSendReply() {
            if(!selectedAdminChatId) return showToast('Select a user first', 'error');
            const input = document.getElementById('admin-reply-input');
            const text = input.value.trim();
            if(!text) return;

            const chat = DB.chats.find(c => c.id === selectedAdminChatId);
            chat.messages.push({ sender: 'admin', text: text, time: new Date().toISOString() });
            
            input.value = '';
            saveData();
            selectAdminChat(selectedAdminChatId); 
            showToast('Reply Sent', 'success');
        }
        
        /* --- DEPOSIT/WD LOGIC --- */
        function setDepositMethod(m) {
            depositMethod = m;
            document.querySelectorAll('#deposit-modal .method-tab').forEach(x => x.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('deposit-currency-label').innerText = m==='usdt'?'USDT':'PKR';
            document.getElementById('deposit-number-display').innerText = DB.settings.depositNum;
            calculateDeposit();
        }
        function calculateDeposit() {
            const a = parseFloat(document.getElementById('deposit-amount').value) || 0;
            const r = depositMethod==='usdt'?DB.settings.rateUSDT:DB.settings.ratePKR;
            document.getElementById('deposit-result-tk').innerText = (a/r).toFixed(2);
        }
        function copyDepositNumber() {
            navigator.clipboard.writeText(document.getElementById('deposit-number-display').innerText);
            showToast('Copied');
        }
        function processDeposit() {
            const a = parseFloat(document.getElementById('deposit-amount').value);
            const r = document.getElementById('deposit-ref').value;
            if(!a || !r) return showToast('Fill fields', 'error');
            const rate = depositMethod==='usdt'?DB.settings.rateUSDT:DB.settings.ratePKR;
            const coins = a / rate;
            const idx = DB.users.findIndex(x => x.id === currentUser.id);
            DB.users[idx].balance += coins;
            addHistory(currentUser.id, 'deposit', coins, depositMethod, r);
            saveData();
            showToast('Deposit Req Sent', 'success');
            closeModal('deposit');
            updateDashboard();
        }

        function setWithdrawMethod(m) {
            withdrawMethod = m;
            document.querySelectorAll('#withdraw-modal .method-tab').forEach(x => x.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('withdraw-currency-label').innerText = m==='usdt'?'USDT':'PKR';
            calculateWithdraw();
        }
        function calculateWithdraw() {
            const c = parseFloat(document.getElementById('withdraw-amount').value) || 0;
            const r = withdrawMethod==='usdt'?DB.settings.rateUSDT:DB.settings.ratePKR;
            const fee = currentUser.isPro?0:(c*r)*0.06;
            document.getElementById('withdraw-result-amount').innerText = ((c*r)-fee).toFixed(2);
            document.getElementById('fee-display').innerText = currentUser.isPro?"Fee: 0%":"Fee: 6%";
        }
        function processWithdraw() {
            const c = parseFloat(document.getElementById('withdraw-amount').value);
            const d = document.getElementById('withdraw-dest').value;
            if(!c || !d) return showToast('Fill fields', 'error');
            if(c < DB.settings.minWithdraw) return showToast('Min withdraw error', 'error');
            const idx = DB.users.findIndex(x => x.id === currentUser.id);
            if(c > DB.users[idx].balance) return showToast('No balance', 'error');
            DB.users[idx].balance -= c;
            addHistory(currentUser.id, 'withdraw', c, withdrawMethod, d);
            saveData();
            showToast('Withdraw Req Sent', 'success');
            closeModal('withdraw');
            updateDashboard();
        }

        function processTransfer() {
            const e = document.getElementById('transfer-email').value;
            const a = parseFloat(document.getElementById('transfer-amount').value);
            if(!e || !a) return showToast('Details missing', 'error');
            const r = DB.users.find(x => x.email === e);
            if(!r || r.id===currentUser.id) return showToast('Invalid User', 'error');
            
            const sIdx = DB.users.findIndex(x => x.id === currentUser.id);
            if(a > DB.users[sIdx].balance) return showToast('Insufficient', 'error');
            
            DB.users[sIdx].balance -= a;
            DB.users[DB.users.findIndex(x=>x.id===r.id)].balance += a;
            addHistory(currentUser.id, 'transfer_out', a, 'Email', e);
            saveData();
            showToast('Sent', 'success');
            updateDashboard();
        }

        /* --- FEED/PROFILE/ADMIN --- */
        function renderFeed() {
            const container = document.getElementById('feed-container');
            container.innerHTML = '';
            
            const shuffled = [...randomPostPool].sort(() => 0.5 - Math.random());
            const top3 = shuffled.slice(0, 3);

            top3.forEach((postData, index) => {
                const div = document.createElement('div');
                div.className = 'post-item';
                
                // Check if post is liked
                const isPro = currentUser.isPro;
                const isLiked = currentUser.likedPosts && currentUser.likedPosts.includes(postData.index); // Note: In a real app, we match ID, not index.
                const isLiked = currentUser.likedPosts && currentUser.likedPosts.includes(postData.index);
                
                div.innerHTML = `
                    <div class="${isPro ? '' : 'locked-content-container'}">
                        ${!isPro ? `
                            <div class="scanline"></div>
                            <div class="locked-overlay">
                                <div class="big-lock-icon">🔒</div>
                                <button class="btn btn-primary" style="padding:5px 10px; font-size:0.7rem; margin-top:10px;" onclick="router('profile')">Upgrade</button>
                            </div>
                            <div class="locked-text">
                                <strong style="color:var(--secondary);">Market News #${index+1}</strong>
                                <div style="margin-top:5px; color:#ccc;">${postData}</div>
                                <div class="likes-container">
                                    <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="likePost(${index})">
                                        <span class="like-icon">${isLiked ? '❤️' : '👍'}</span>
                                        <span class="like-count" id="likes-count-${index}">${isLiked ? 1 : 0}</span>
                                    <span id="likes-count-${index}" style="margin-left: 10px;">Like</span>
                                    </button>
                            </div>
                        </div>
                    ` : `
                        <strong style="color:var(--secondary);">Market News #${index+1}</strong>
                        <div style="margin-top:10px; color:white;">${postData}</div>
                        <div class="likes-container">
                            <button class="like-btn" onclick="likePost(${index})">
                                <span class="like-icon">👍</span>
                                <span class="like-count" id="likes-count-${index}">0</span>
                                <span style="margin-left: 10px;">Like</span>
                            </button>
                        </div>
                    `
                container.appendChild(div);
            });
        }

        /* --- HISTORY --- */
        function renderProfile() {
            document.getElementById('profile-name').innerText = currentUser.name;
            document.getElementById('profile-email').innerText = currentUser.email;
            document.getElementById('profile-date').innerText = currentUser.joined;
            
            const statusEl = document.getElementById('profile-status');
            const avatarText = document.getElementById('profile-avatar-text');
            avatarText.innerText = currentUser.name.charAt(0).toUpperCase();

            if(currentUser.isPro) {
                statusEl.innerText = "PRO USER";
                statusEl.style.color = "var(--secondary)";
                avatarText.style.background = "linear-gradient(135deg, #FFD700, #FF8C00)";
                avatarText.style.color = "#000";
            } else {
                statusEl.innerText = "NORMAL";
                statusEl.style.color = "var(--text-gray)";
                avatarText.style.background = "linear-gradient(135deg, #444, #222)";
                avatarText.style.color = "#ccc";
            }
            
            const upgradeCard = document.getElementById('upgrade-card-box');
            if(currentUser.isPro) {
                upgradeCard.classList.add('hidden');
            } else {
                upgradeCard.classList.remove('hidden');
            }

            const h = document.getElementById('history-list');
            h.innerHTML = '';
            const list = DB.history.filter(x=>x.userId===currentUser.id).reverse();
            
            list.forEach((x, index) => {
                const div = document.createElement('div');
                div.style.borderBottom='1px solid #444';
                div.style.padding='5px';
                div.style.fontSize='0.8rem';
                div.style.opacity = '0';
                div.style.animation = `fadeIn ${index * 0.05}s forwards`;
                div.innerHTML = `<span style="color:${x.type.includes('deposit')||x.type.includes('in')?'var(--success)':'var(--danger)'}">${x.type} ${x.amountTK} TK</span>`;
                h.appendChild(div);
            });
        }
        function renderAdmin() {
            document.getElementById('admin-rate-pkr').value = DB.settings.ratePKR;
            document.getElementById('admin-rate-usdt').value = DB.settings.rateUSDT;
            document.getElementById('admin-deposit-num').value = DB.settings.depositNum;
            document.getElementById('admin-min-withdraw').value = DB.settings.minWithdraw;
            document.getElementById('admin-auto-rate').checked = DB.settings.autoRate;
            document.getElementById('admin-drift-limit').value = DB.settings.driftLimit;
            
            if(DB.settings.autoRate) {
                document.getElementById('drift-control').classList.remove('hidden');
            } else {
                document.getElementById('drift-control').classList.add('hidden');
            }

            const t = document.getElementById('admin-user-list');
            t.innerHTML = '';
            DB.users.forEach(u => {
                if(u.role==='admin') return;
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.name}</td><td>${u.isPro?'Pro':'Norm'}</td><td>${u.balance.toFixed(2)}</td><td><button style="background:red; border:none; color:white; padding:2px 5px;" onclick="banUser(${u.id})">Ban</button></td>`;
                t.appendChild(tr);
            });
        }

        /* --- ADMIN FUNCTIONS --- */
        function renderAdminUI() {
            document.getElementById('admin-drift-limit').value = DB.settings.driftLimit;
        }

        function updateManualSettings() {
            if(DB.settings.autoRate) return; 
            DB.settings.ratePKR = parseInt(document.getElementById('admin-rate-pkr').value);
            DB.settings.rateUSDT = parseFloat(document.getElementById('admin-rate-usdt').value);
            saveData();
            updateDashboard();
            showToast('Rates Updated', 'success');
        }

        function updateSettings() {
            DB.settings.depositNum = document.getElementById('admin-deposit-num').value;
            DB.settings.minWithdraw = parseFloat(document.getElementById('admin-min-withdraw').value);
            DB.settings.driftLimit = parseInt(document.getElementById('admin-drift-limit').value);
            saveData();
            showToast('Settings Saved', 'success');
        }

        function toggleAutoRate() {
            const isAuto = document.getElementById('admin-auto-rate').checked;
            DB.settings.autoRate = isAuto;
            saveData();
            renderAdmin();
            showToast(isAuto ? 'Auto Rate Enabled' : 'Manual Mode Active', 'success');
        }

        function postNews() {
            const i = document.getElementById('admin-news-input').value;
            if(!i) return;
            DB.news.unshift(i);
            saveData();
            showToast('Posted', 'success');
        }
        function banUser(id) {
            const u = DB.users.find(x=>x.id===id);
            u.banned = !u.banned;
            saveData();
            renderAdmin();
            showToast('User Status Updated', 'info');
        }

        /* --- HELPERS --- */
        function addHistory(uid, type, amt, mtd, ref) {
            DB.history.push({ id:Date.now(), userId:uid, type, amountTK:amt, method:mtd, ref, date:new Date().toISOString() });
        }
        function saveData() {
            localStorage.setItem('tk_users', JSON.stringify(DB.users));
            localStorage.setItem('tk_settings', JSON.stringify(DB.settings));
            localStorage.setItem('tk_news', JSON.stringify(DB.news));
            localStorage.setItem('tk_posts', JSON.stringify(DB.posts)); // Save posts too
            localStorage.setItem('tk_history', JSON.stringify(DB.history));
            localStorage.setItem('tk_chats', JSON.stringify(DB.chats)); 
        }
        function showToast(m, t='info') {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className='toast';
            d.innerText=m;
            if(t==='error') d.style.borderLeftColor='var(--danger)';
            c.appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }
        window.onresize = () => {
            const c = document.getElementById('marketChart');
            if(c) c.width = c.parentElement.offsetWidth;
        }
    </script>
</body>
</html>
